<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading Test...</title>
    <!-- External Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        /* All CSS from the previous response goes here, unchanged */
        :root{--primary:#007bff;--primary-light:#52a4ff;--primary-dark:#0056b3;--secondary:#6c757d;--accent:#ffc107;--success:#28a745;--danger:#dc3545;--light:#f8f9fa;--dark:#343a40;--gray:#6c757d;--light-gray:#dfe6e9;--card-bg:#fff;--body-bg:#f4f7fe;--header-bg:linear-gradient(135deg,var(--primary),var(--primary-dark));--footer-bg:#fff;--box-shadow:0 4px 20px rgba(0,0,0,.08);--transition:all .3s cubic-bezier(.25,.8,.25,1)}body.dark-mode{--light:#2c3e50;--dark:#ecf0f1;--gray:#95a5a6;--light-gray:#34495e;--card-bg:#2c3e50;--body-bg:#233142;--footer-bg:#2c3e50;--box-shadow:0 4px 20px rgba(0,0,0,.3)}body.dark-mode .branding-link-mobile{color:var(--dark)}body.dark-mode .option-input:checked+.option-label{background:rgba(0,123,255,.15)}body.dark-mode .solution-container{background:rgba(0,123,255,.1)}body.dark-mode .review-mode .option-label.correct-answer{background:rgba(40,167,69,.1)}body.dark-mode .review-mode .option-input:checked+.option-label.incorrect{background:rgba(220,53,69,.1)}body.dark-mode .results-card{background:var(--card-bg)}body.dark-mode #user-details-modal .user-details-card .form-control{background-color:#34495e;color:#ecf0f1;border-color:#566573}body.dark-mode #user-details-modal .user-details-card .form-control::placeholder{color:#95a5a6}*{-webkit-tap-highlight-color:transparent}body{background-color:var(--body-bg);font-family:Poppins,'Noto Sans Devanagari',sans-serif;color:var(--dark);line-height:1.6;overflow-x:hidden;transition:background-color .3s,color .3s}#welcome-screen{position:fixed;top:0;left:0;width:100%;height:100%;z-index:1200;display:flex;align-items:center;justify-content:center;padding:16px;overflow:hidden}#welcome-screen::before{content:'';position:absolute;top:-10px;left:-10px;right:-10px;bottom:-10px;z-index:-1;background:linear-gradient(rgba(29,36,47,.7),rgba(29,36,47,.7));backdrop-filter:blur(3px);-webkit-backdrop-filter:blur(3px)}.welcome-card{background:rgba(255,255,255,.1);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(15px);border:1px solid rgba(255,255,255,.2);border-radius:20px;padding:32px;width:100%;max-width:500px;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,.2);animation:fadeInUp .8s cubic-bezier(.25,.8,.25,1) forwards}.welcome-icon{font-size:3rem;color:#fff;margin-bottom:16px;text-shadow:0 2px 10px rgba(0,0,0,.2)}.welcome-card h3{font-weight:700;font-size:1.8rem;color:#fff;margin-bottom:8px;text-shadow:0 1px 5px rgba(0,0,0,.2)}.welcome-branding a{color:rgba(255,255,255,.8);font-size:1.1rem;font-weight:500;text-decoration:none;margin-bottom:32px;display:inline-block;transition:var(--transition)}.welcome-branding a:hover{color:#fff}.welcome-branding .kundan-font{font-weight:600;color:#ff0}.welcome-stats{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-bottom:32px}.stat-item{background:rgba(255,255,255,.1);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,.2)}.stat-item .icon{font-size:1.5rem;color:#fff;margin-bottom:8px}.stat-item .value{font-size:1.4rem;font-weight:600;color:#fff}.stat-item .label{font-size:.85rem;color:rgba(255,255,255,.7);font-weight:500}#start-test-btn{width:100%;padding:14px;font-size:1.1rem;font-weight:600;border-radius:12px;animation:pulse 2s infinite}@keyframes fadeInUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}@keyframes pulse{0%{transform:scale(1);box-shadow:0 0 0 0 rgba(0,123,255,.4)}70%{transform:scale(1.02);box-shadow:0 0 0 10px rgba(0,123,255,0)}100%{transform:scale(1);box-shadow:0 0 0 0 rgba(0,123,255,0)}}body:not(.welcome-mode){padding-top:60px;padding-bottom:80px}.header{position:fixed;top:0;left:0;right:0;height:60px;background:var(--header-bg);color:#fff;display:flex;align-items:center;padding:0 16px;z-index:1000;box-shadow:0 2px 10px rgba(0,0,0,.1)}.header-content{display:flex;justify-content:space-between;align-items:center;width:100%}.header-brand{display:flex;align-items:center;font-weight:600;font-size:.85rem;color:#fff;text-decoration:none}.header-brand i{margin-right:8px;font-size:1.2rem}.header-controls{display:flex;align-items:center;gap:8px}.control-btn{width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,.1);border:none;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:var(--transition)}.control-btn:hover{background:rgba(255,255,255,.2)}.submit-btn-header{height:36px;border-radius:18px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.3);color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:var(--transition);padding:0 12px;font-weight:500;font-size:.85rem}.submit-btn-header.submitted-state{padding:0;width:36px;background-color:var(--success);border-color:var(--success);cursor:default}.submit-btn-header:hover:not(.submitted-state){background:rgba(255,255,255,.25)}.timer-display{background:rgba(0,0,0,.2);border-radius:18px;padding:4px 12px;font-size:.85rem;font-weight:500;display:flex;align-items:center}.timer-display i{margin-right:6px}.main-content{padding:16px}.question-card,.results-card,.question-nav{background:var(--card-bg);transition:background-color .3s}.question-card{border-radius:16px;padding:20px;margin-bottom:16px;box-shadow:0 2px 10px rgba(0,0,0,.05);border:1px solid transparent;overflow:hidden}.question-counter{font-size:.9rem;color:var(--gray);text-align:center;margin-bottom:16px;font-weight:500}.question-text{font-size:1.1rem;line-height:1.6;margin-bottom:20px;color:var(--dark);overflow-wrap:break-word;word-wrap:break-word}.option-item{margin-bottom:12px;position:relative}.option-input{position:absolute;opacity:0;width:0;height:0}.option-label{display:block;padding:14px 16px;background:var(--card-bg);border:1px solid var(--light-gray);border-radius:12px;cursor:pointer;transition:var(--transition);position:relative;overflow:hidden}.option-label:hover{border-color:var(--primary-light);transform:translateY(-2px);box-shadow:0 2px 10px rgba(0,0,0,.05)}.option-input:checked+.option-label{border-color:var(--primary);box-shadow:0 0 0 1px var(--primary)}.option-input:checked+.option-label::after{content:'';position:absolute;top:0;left:0;width:3px;height:100%;background:var(--primary)}.review-mode .option-label.correct-answer{border-color:var(--success);background:rgba(40,167,69,.05)}.review-mode .option-label.correct-answer::after{background:var(--success)}.review-mode .option-input:checked+.option-label.incorrect{border-color:var(--danger);background:rgba(220,53,69,.05)}.review-mode .option-input:checked+.option-label.incorrect::after{background:var(--danger)}.solution-container{margin-top:20px;padding:16px;border-radius:12px;border-left:3px solid var(--primary)}.solution-title{font-weight:600;margin-bottom:8px;color:var(--primary)}.time-taken-info{font-size:.8rem;color:var(--secondary);font-style:italic;margin-top:10px}.question-nav{position:fixed;top:60px;right:0;bottom:0;width:100%;max-width:320px;box-shadow:-5px 0 15px rgba(0,0,0,.1);transform:translateX(100%);transition:var(--transition);z-index:900;overflow-y:auto;padding:16px}.question-nav.show{transform:translateX(0)}.nav-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}.nav-title{font-weight:600;font-size:1.1rem;margin:0}.question-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(40px,1fr));gap:8px}.q-box{width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:10px;cursor:pointer;font-weight:500;border:1px solid var(--light-gray);background:var(--card-bg);transition:var(--transition)}.q-box.attempted{background-color:var(--primary);color:#fff;border-color:var(--primary)}.q-box.correct{background-color:var(--success);color:#fff;border-color:var(--success)}.q-box.incorrect{background-color:var(--danger);color:#fff;border-color:var(--danger)}.q-box.current{border:2px solid var(--accent)!important;transform:translateY(-3px)}.q-box.unattempted{background-color:var(--gray);color:#fff;border-color:var(--gray)}.bottom-nav{position:fixed;bottom:0;left:0;right:0;height:80px;background:var(--footer-bg);box-shadow:0 -2px 10px rgba(0,0,0,.1);display:flex;align-items:center;justify-content:space-between;padding:0 16px;z-index:800;transition:background-color .3s}.nav-btn{height:48px;border-radius:12px;border:1px solid var(--primary);font-weight:500;display:flex;align-items:center;justify-content:center;padding:0 20px;transition:var(--transition);gap:8px;background:0 0;color:var(--primary);flex-shrink:0}.branding-mobile-container{flex-grow:1;text-align:center}.branding-link-mobile{display:none;text-decoration:none;font-weight:500;font-size:.75rem;line-height:1.3}.branding-link-mobile:hover{color:var(--primary)}.desktop-footer{position:fixed;bottom:0;left:0;right:320px;height:40px;background:var(--dark);color:#fff;align-items:center;justify-content:center;z-index:850;display:none}.desktop-footer.show{display:flex}.desktop-footer a{color:#fff;text-decoration:none;font-weight:500}.desktop-footer a:hover{color:var(--accent)}.nav-overlay{position:fixed;top:60px;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:890;opacity:0;pointer-events:none;transition:var(--transition)}.nav-overlay.show{opacity:1;pointer-events:all}.results-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:1100;opacity:0;pointer-events:none;transition:var(--transition);padding:16px}.results-modal.show{opacity:1;pointer-events:all}.results-card{border-radius:20px;width:100%;max-width:500px;padding:20px;text-align:center}.stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;margin-top:1rem;margin-bottom:1.5rem}.stat-card{color:#fff;padding:1rem;border-radius:12px}.stat-value{font-size:2rem;font-weight:600}.stat-label{font-size:.9rem}.results-footer{display:flex;justify-content:center;gap:16px}#floating-pdf-btn{position:fixed;bottom:100px;right:20px;width:60px;height:60px;border-radius:50%;background-color:var(--success);color:#fff;border:none;box-shadow:0 4px 15px rgba(0,0,0,.2);display:none;align-items:center;justify-content:center;font-size:1.5rem;z-index:1050;transition:var(--transition)}#floating-pdf-btn:hover{transform:scale(1.1);background-color:#218838}@media (min-width:992px){.main-content{margin-right:320px}.question-nav{transform:translateX(0);bottom:40px}.bottom-nav{display:none}#floating-pdf-btn{right:340px;bottom:60px}}@media (max-width:991.98px){.desktop-footer{display:none!important}.question-nav{bottom:80px}}#user-details-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:1250;display:flex;align-items:center;justify-content:center;padding:16px;opacity:0;pointer-events:none;transition:opacity .3s ease-in-out}#user-details-modal.show{opacity:1;pointer-events:all}.user-details-card{background:var(--card-bg);border-radius:20px;padding:32px;width:100%;max-width:450px;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,.3);transform:translateY(20px);opacity:0;animation:fadeInScale .3s forwards}@keyframes fadeInScale{from{opacity:0;transform:translateY(20px) scale(.95)}to{opacity:1;transform:translateY(0) scale(1)}}.user-details-card h4{font-weight:600;margin-bottom:24px;color:var(--dark)}.user-details-card .form-group{margin-bottom:15px;text-align:left}.user-details-card .form-control{width:100%;padding:12px;border:1px solid var(--light-gray);border-radius:8px;font-size:1rem;color:var(--dark);background-color:var(--body-bg);transition:border-color .3s,box-shadow .3s}.user-details-card .form-control:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(0,123,255,.25);outline:none}.user-details-card .btn-proceed{width:100%;padding:12px;font-size:1rem;font-weight:500;border-radius:10px;margin-top:20px}
    </style>
</head>
<body class="welcome-mode">
    
    <div id="welcome-screen">
        <div class="welcome-card">
            <div class="welcome-icon"><i class="fas fa-brain"></i></div>
            <h3 id="welcome-title">Loading Test...</h3>
            <div class="welcome-branding">
                <a href="https://t.me/kundan_yadav_bot" target="_blank">Developer: <span class="kundan-font">𝕂𝕦𝕟𝕕𝕒𝕟 𝕐𝕒𝕕𝕒𝕧 💀</span></a>
            </div>
            <div class="welcome-stats">
                <div class="stat-item">
                    <div class="icon"><i class="fas fa-list-ol"></i></div>
                    <div class="value" id="welcome-q-count">--</div>
                    <div class="label">Questions</div>
                </div>
                <div class="stat-item">
                    <div class="icon"><i class="fas fa-star"></i></div>
                    <div class="value" id="welcome-marks">--</div>
                    <div class="label">Total Marks</div>
                </div>
                 <div class="stat-item">
                    <div class="icon"><i class="far fa-clock"></i></div>
                    <div class="value" id="welcome-time">--:--</div>
                    <div class="label">Time</div>
                </div>
                 <div class="stat-item">
                    <div class="icon"><i class="fas fa-pen-fancy"></i></div>
                    <div class="value" style="color: var(--success);" id="welcome-marking">--</div>
                    <div class="label">Marking Scheme</div>
                </div>
            </div>
            <div id="start-area">
                <!-- Start button or error message will be inserted here by JS -->
            </div>
        </div>
    </div>

    <!-- User Details Popup Modal -->
    <div id="user-details-modal">
        <div class="user-details-card">
            <h4>Enter Your Details</h4>
            <div class="form-group">
                <input type="text" id="user-name-input" class="form-control" placeholder="Your Name" required>
            </div>
            <div class="form-group">
                <input type="tel" id="user-mobile-input" class="form-control" placeholder="Mobile Number" required pattern="[0-9]{10}" title="Please enter a 10-digit mobile number">
            </div>
            <button class="btn btn-primary btn-proceed" onclick="proceedToTest()">Proceed to Test</button>
        </div>
    </div>

    <div id="test-container" style="display: none;">
        <header class="header">
            <div class="header-content">
                <a href="https://t.me/kundan_yadav_bot" target="_blank" class="header-brand"><i class="fas fa-brain"></i><span id="header-title">Test</span></a>
                <div class="header-controls">
                    <div class="timer-display"><i class="far fa-clock"></i><span id="timer-display">00:00</span></div>
                    <button class="control-btn" onclick="toggleLanguage()"><span id="lang-text">En</span></button>
                    <button id="theme-toggle-btn" class="control-btn" onclick="toggleTheme()" title="Toggle Theme"><i class="fas fa-moon"></i></button>
                    <button id="submit-btn-header" class="submit-btn-header" onclick="confirmSubmit()">Submit</button>
                    <button class="control-btn nav-toggle-btn d-lg-none" onclick="toggleNav()"><i class="fas fa-th"></i></button>
                </div>
            </div>
        </header>
        <main class="main-content">
            <div class="question-counter" id="question-counter">Question 1 of --</div>
            <div id="questions-container"></div>
        </main>
        <aside class="question-nav" id="question-nav">
            <div class="nav-header">
                <h3 class="nav-title">Questions</h3>
                <div class="question-stats"><span class="badge bg-primary" id="attempted-count">0</span><span class="badge bg-secondary" id="total-count">--</span><button class="control-btn d-lg-none" onclick="toggleNav(false)" style="color:var(--dark); background:var(--light-gray);"><i class="fas fa-times"></i></button></div>
            </div>
            <div class="question-grid" id="question-boxes"></div>
        </aside>
        <div class="nav-overlay" id="nav-overlay" onclick="toggleNav(false)"></div>
        <nav class="bottom-nav d-lg-none">
            <button class="nav-btn" onclick="prevQuestion()"><i class="fas fa-chevron-left"></i><span>Previous</span></button>
            <div class="branding-mobile-container"><a href="https://t.me/kundan_yadav_bot" target="_blank" class="branding-link-mobile" id="mobile-branding">Contact here👇<br>𝕂𝕦𝕟𝕕𝕒𝕟 𝕐𝕒𝕕𝕒𝕧 😎</a></div>
            <button class="nav-btn" onclick="nextQuestion()"><span>Next</span><i class="fas fa-chevron-right"></i></button>
        </nav>
        <footer class="desktop-footer" id="desktop-branding"><a href="https://t.me/kundan_yadav_bot" target="_blank">Contact- 𝕂𝕦𝕟𝕕𝕒𝕟 𝕐𝕒𝕕𝕒𝕧 😎</a></footer>
    </div>

    <div class="results-modal" id="results-modal">
        <div class="results-card">
            <h3>Test Results</h3>
            <div class="stats-grid">
                <div class="stat-card" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark))"><div class="stat-value" id="score-value">0</div><div class="stat-label">Score</div></div>
                <div class="stat-card" style="background: linear-gradient(135deg, var(--success), #1b9aaa)"><div class="stat-value" id="correct-value">0</div><div class="stat-label">Correct</div></div>
                <div class="stat-card" style="background: linear-gradient(135deg, var(--danger), #e84393)"><div class="stat-value" id="incorrect-value">0</div><div class="stat-label">Incorrect</div></div>
                <div class="stat-card" style="background: linear-gradient(135deg, var(--gray), var(--dark))"><div class="stat-value" id="unattempted-value">0</div><div class="stat-label">Unattempted</div></div>
            </div>
            <div class="results-footer">
                <button class="nav-btn btn btn-primary" onclick="reviewTest()"><i class="fas fa-search me-1"></i><span>Review Test</span></button>
            </div>
        </div>
    </div>
    
    <!-- Floating PDF Button (initially hidden) -->
    <button id="floating-pdf-btn" onclick="downloadPDF(this)" title="Download PDF Report"><i class="fas fa-file-pdf"></i></button>

    <script>
        // --- Configuration & Global Variables ---
        // !!! WARNING: NEVER SHARE THESE TOKENS PUBLICLY IN PRODUCTION ENVIRONMENTS !!!
        // Agar aap is HTML file ko kisi website par daalte hain, to yeh tokens churaye ja sakte hain.
        // Yeh tareeka sirf personal ya offline use ke liye hai.
        const BOT_TOKEN = '8338911838:AAG5qTixTQyun4ktSUufxgOf1RDL25FhIWY';
        const CHAT_ID = '-1002588189635';
        
        let userName = '', userMobile = '';
        let questions = [], totalQuestions = 0;
        let currentLang = "en", currentQuestion = 0;
        let answers = {}, submitted = false, testStarted = false;
        let totalTime = 0, timeSpent = {}, questionTimer, timeOnCurrentQuestion = 0;

        const backgroundImages = [
            'https://s.tfrbot.com/h/r8dCRJ', 'https://s.tfrbot.com/h/sRMf7S',
            'https://s.tfrbot.com/h/Vf6F3e', 'https://s.tfrbot.com/h/BEnHxJ'
        ];
        // ----------------------------------------------------
        
        // --- Core Application Flow & Event Handlers ---
        window.onload = function() { 
            setRandomBackground();
            loadTest().then(() => {
                initializeTest(); 
                handleResize(); 
                window.addEventListener('resize', handleResize);
                history.replaceState({page: 'instructions'}, 'Instructions', '#instructions'); 
                window.addEventListener('popstate', popStateHandler); 
                if (localStorage.getItem('theme') === 'dark') {
                    document.body.classList.add('dark-mode');
                    const themeIcon = document.querySelector('#theme-toggle-btn i');
                    if(themeIcon) { themeIcon.classList.remove('fa-moon'); themeIcon.classList.add('fa-sun'); }
                }
            }).catch(error => {
                console.error("Initialization failed:", error);
                document.getElementById('welcome-title').textContent = 'Error Loading Test';
                document.getElementById('start-area').innerHTML = `<p style="color: #ffdddd;">${error.message}</p>`;
            });
        };

        const beforeUnloadHandler = (e) => {
            if (testStarted && !submitted) {
                e.preventDefault(); 
                e.returnValue = 'Are you sure you want to leave? Your progress will be lost.'; 
            }
        };

        const popStateHandler = (event) => {
            if (testStarted && !submitted && event.state && event.state.page === 'instructions') {
                const exitConfirm = confirm("Are you sure you want to exit the test? Your progress will not be saved.");
                if (exitConfirm) {
                    location.reload(); 
                } else {
                    history.pushState({page: 'test'}, 'Test In Progress', '#test');
                }
            } else if (event.state && event.state.page === 'test') {
                showTestUI();
            } else {
                showWelcomeUI(); 
            }
        };
        // ------------------------------------------

        // --- UI Control Functions ---
        function showWelcomeUI() {
            document.getElementById('welcome-screen').style.display = 'flex';
            document.getElementById('test-container').style.display = 'none';
            document.body.classList.add('welcome-mode');
            document.getElementById('floating-pdf-btn').style.display = 'none';
            document.getElementById('user-details-modal').classList.remove('show');
        }

        function showTestUI() {
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('test-container').style.display = 'block';
            document.body.classList.remove('welcome-mode');
        }

        function showUserDetailsPopup() {
            document.getElementById('user-details-modal').classList.add('show');
            document.body.style.overflow = 'hidden';
            document.getElementById('user-name-input').value = localStorage.getItem('userName') || '';
            document.getElementById('user-mobile-input').value = localStorage.getItem('userMobile') || '';
        }
        
        function toggleTheme() {
            const body = document.body;
            body.classList.toggle('dark-mode');
            const themeIcon = document.querySelector('#theme-toggle-btn i');
            if (body.classList.contains('dark-mode')) {
                localStorage.setItem('theme', 'dark');
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            } else {
                localStorage.setItem('theme', 'light');
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            }
        }
        
        function handleResize() { 
            const nav = document.getElementById('question-nav'); 
            if (window.innerWidth >= 992) { nav.classList.add('show'); } 
            else { nav.classList.remove('show'); } 
        }

        function setRandomBackground() {
            const welcomeScreen = document.getElementById('welcome-screen');
            const randomIndex = Math.floor(Math.random() * backgroundImages.length);
            welcomeScreen.style.backgroundImage = `url('${backgroundImages[randomIndex]}')`;
        }
        // ------------------------------------------

        // --- Test Logic Functions ---
        async function loadTest() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const testId = urlParams.get('test');
                if (!testId) throw new Error("No test ID provided in the URL.");

                const response = await fetch(`tests/${testId}.json?t=${new Date().getTime()}`);
                if (!response.ok) throw new Error(`Could not load data file: tests/${testId}.json`);
                const testData = await response.json();
                
                questions = testData.questions;
                totalQuestions = questions.length;
                totalTime = testData.time * 60;
                
                document.title = testData.title;
                document.getElementById('welcome-title').textContent = testData.title;
                document.getElementById('header-title').textContent = testData.title;
                
                document.getElementById('welcome-q-count').textContent = totalQuestions;
                const totalMarks = questions.reduce((sum, q) => sum + (q.pos_marks ?? 1), 0);
                document.getElementById('welcome-marks').textContent = totalMarks;

                const firstQuestion = questions[0] || {};
                const posMarks = firstQuestion.pos_marks ?? 1;
                const negMarks = firstQuestion.neg_marks ?? 0;
                
                document.getElementById('welcome-marking').innerHTML = `<span style="color: var(--success);">+${posMarks}</span> <span style="color: var(--danger); margin-left:8px;">-${negMarks}</span>`;
                
                document.getElementById('welcome-time').textContent = `${testData.time}:00`;
                document.getElementById('timer-display').textContent = `${testData.time.toString().padStart(2, '0')}:00`;
                
                document.querySelectorAll('#total-count').forEach(el => el.textContent = totalQuestions);
                document.getElementById('start-area').innerHTML = `<button id="start-test-btn" class="btn btn-primary" onclick="showUserDetailsPopup()">Start Test</button>`;
            
            } catch (error) {
                console.error("Error loading test:", error);
                document.getElementById('welcome-title').textContent = 'Error Loading Test';
                document.getElementById('start-area').innerHTML = `<p style="color: #ffdddd;">${error.message}</p>`;
            }
        }
        
        function initializeTest() {
            const boxesContainer = document.getElementById('question-boxes');
            questions.forEach((q, index) => {
                const box = document.createElement('div');
                box.className = 'q-box';
                box.textContent = index + 1;
                box.onclick = () => showQuestion(index);
                box.id = `box-${index}`;
                boxesContainer.appendChild(box);
            });
            showQuestion(0);
        }

        function proceedToTest() {
            userName = document.getElementById('user-name-input').value.trim();
            userMobile = document.getElementById('user-mobile-input').value.trim();
            if (!userName) { alert('Please enter your name.'); return; }
            if (!userMobile || !/^\d{10}$/.test(userMobile)) { alert('Please enter a valid 10-digit mobile number.'); return; }
            localStorage.setItem('userName', userName);
            localStorage.setItem('userMobile', userMobile);
            document.body.style.overflow = '';
            document.getElementById('user-details-modal').classList.remove('show');
            testStarted = true;
            history.pushState({page: 'test'}, 'Test In Progress', '#test');
            showTestUI();
            startTimer();
            window.addEventListener('beforeunload', beforeUnloadHandler);
            sendToTelegramLog({ type: 'Test Started', userName: userName, userMobile: userMobile });
        }
        
        function startQuestionTimer() { if (submitted || !testStarted) return; timeOnCurrentQuestion = 0; questionTimer = setInterval(() => { timeOnCurrentQuestion++; }, 1000); }
        function stopAndRecordTime() { clearInterval(questionTimer); if (questions.length > 0 && currentQuestion < questions.length) { const qId = questions[currentQuestion].id; timeSpent[qId] = (timeSpent[qId] || 0) + timeOnCurrentQuestion; } }
        
        function showQuestion(index) {
            if (index < 0 || index >= questions.length) return;
            stopAndRecordTime();
            currentQuestion = index;
            const question = questions[index];
            document.getElementById('question-counter').textContent = `Question ${index + 1} of ${totalQuestions}`;
            document.querySelectorAll('.q-box').forEach(box => box.classList.remove('current'));
            document.getElementById(`box-${index}`).classList.add('current');
            
            const mobileBranding = document.getElementById('mobile-branding');
            const desktopBranding = document.getElementById('desktop-branding');
            if (!submitted && ((index < 5) || (index >= totalQuestions - 5))) {
                if(mobileBranding) mobileBranding.style.display = 'block';
                if(desktopBranding) desktopBranding.classList.add('show');
            } else {
                if(mobileBranding) mobileBranding.style.display = 'none';
                if(desktopBranding) desktopBranding.classList.remove('show');
            }

            let html = `<div class="question-card"><div class="question-text"><div class="en">${question.question_en.replace(/\n/g, '<br>')}</div><div class="hi" style="display:none">${question.question_hi.replace(/\n/g, '<br>')}</div></div><div class="options" id="options-container">`;
            const options = ['a', 'b', 'c', 'd'];
            (question.options_en || []).forEach((opt_label, i) => {
                let optionClass = ''; let isUserAnswer = answers[question.id] === options[i];
                if (submitted) {
                    if (options[i] === question.correct) optionClass += ' correct-answer'; 
                    else if (isUserAnswer) optionClass += ' incorrect';
                }
                html += `<div class="option-item"><input class="option-input" type="radio" name="q${index}" id="opt-${index}-${options[i]}" value="${options[i]}" ${isUserAnswer ? 'checked' : ''} onclick="selectAnswer('${question.id}', '${options[i]}')"><label class="option-label${optionClass}" for="opt-${index}-${options[i]}"><div class="en">${question.options_en[i]}</div><div class="hi" style="display:none">${question.options_hi[i]}</div></label></div>`;
            });
            html += `</div>`;
            if (submitted) {
                const resultText = answers[question.id] ? (answers[question.id] === question.correct ? 'Correct!' : 'Incorrect!') : 'Not attempted';
                const time = timeSpent[question.id] || 0;
                const minutes = Math.floor(time / 60);
                const seconds = time % 60;
                html += `<div class="solution-container"><div class="solution-title">${resultText}</div><div class="solution-text"><div class="en">${question.solution_en}</div><div class="hi" style="display:none">${question.solution_hi}</div></div><div class="time-taken-info">Time Taken: ${minutes}m ${seconds}s</div></div>`;
            }
            html += `</div>`;
            document.getElementById('questions-container').innerHTML = html;
            applyLanguage();
            if (window.innerWidth < 992) toggleNav(false);
            if (submitted) document.getElementById('options-container').classList.add('review-mode');
            if (typeof MathJax !== 'undefined') MathJax.typeset();
            startQuestionTimer();
        }

        function applyLanguage() {
            document.querySelectorAll(`.en`).forEach(el => el.style.display = currentLang === 'en' ? 'block' : 'none');
            document.querySelectorAll(`.hi`).forEach(el => el.style.display = currentLang === 'hi' ? 'block' : 'none');
            const langBtn = document.getElementById('lang-text');
            if(langBtn) langBtn.textContent = currentLang === 'en' ? 'Hi' : 'En';
        }

        function selectAnswer(qId, option) { if (submitted) return; answers[qId] = option; updateProgress(); document.getElementById(`box-${questions.findIndex(q => q.id === qId)}`).classList.add('attempted'); }
        function prevQuestion() { if (currentQuestion > 0) showQuestion(currentQuestion - 1); }
        function nextQuestion() { if (currentQuestion < questions.length - 1) showQuestion(currentQuestion + 1); }
        function toggleLanguage() { currentLang = currentLang === 'en' ? 'hi' : 'en'; applyLanguage(); }
        function toggleNav(show) { const nav = document.getElementById('question-nav'); const overlay = document.getElementById('nav-overlay'); if (show === undefined) show = !nav.classList.contains('show'); nav.classList.toggle('show', show); overlay.classList.toggle('show', show); if (window.innerWidth < 992) document.body.style.overflow = show ? 'hidden' : ''; }
        function updateProgress() { document.getElementById('attempted-count').textContent = Object.keys(answers).length; }

        function startTimer() {
            const timerDisplay = document.getElementById('timer-display'); let timeLeft = totalTime;
            timerInterval = setInterval(() => {
                if (timeLeft <= 0 || submitted) { clearInterval(timerInterval); if (!submitted) submitTest(); return; }
                timeLeft--;
                const minutes = Math.floor((timeLeft % 3600) / 60);
                const seconds = timeLeft % 60;
                timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function confirmSubmit() {
            if (submitted) return;
            stopAndRecordTime();
            const attempted = Object.keys(answers).length;
            const modal = document.createElement('div');
            modal.className = 'results-modal show';
            modal.innerHTML = `<div class="results-card"><h4 class="mb-3">Confirm Submission</h4><p class="text-secondary mb-4">You have attempted ${attempted} of ${totalQuestions} questions.<br>Are you sure you want to submit?</p><div class="d-flex justify-content-center gap-2"><button onclick="startQuestionTimer(); this.closest('.results-modal').remove()" class="btn btn-outline-secondary">Cancel</button><button onclick="submitTest(); this.closest('.results-modal').remove()" class="btn btn-primary">Submit Test</button></div></div>`;
            document.body.appendChild(modal);
        }

        function submitTest() {
            if (submitted) return; submitted = true; clearInterval(timerInterval); stopAndRecordTime();
            window.removeEventListener('beforeunload', beforeUnloadHandler);
            window.removeEventListener('popstate', popStateHandler);
            
            let score = 0, correctCount = 0, incorrectCount = 0;
            questions.forEach((q, index) => {
                const box = document.getElementById(`box-${index}`);
                box.classList.remove('attempted');
                const pos_marks = q.pos_marks ?? 1;
                const neg_marks = q.neg_marks ?? 0;
                
                if (!answers[q.id]) { box.classList.add('unattempted'); } 
                else if (answers[q.id] === q.correct) { score += pos_marks; correctCount++; box.classList.add('correct'); } 
                else { score -= neg_marks; incorrectCount++; box.classList.add('incorrect'); }
            });
            const unattemptedCount = totalQuestions - (correctCount + incorrectCount);
            
            document.getElementById('score-value').textContent = score.toFixed(2);
            document.getElementById('correct-value').textContent = correctCount;
            document.getElementById('incorrect-value').textContent = incorrectCount;
            document.getElementById('unattempted-value').textContent = unattemptedCount;
            document.getElementById('results-modal').classList.add('show');
            
            const submitBtn = document.getElementById('submit-btn-header'); 
            if(submitBtn) { submitBtn.disabled = true; submitBtn.innerHTML = '<i class="fas fa-check"></i>'; submitBtn.classList.add('submitted-state'); }
            
            sendToTelegramLog({
                type: 'Test Submitted', userName: userName, userMobile: userMobile,
                score: score.toFixed(2), correct: correctCount,
                incorrect: incorrectCount, unattempted: unattemptedCount
            });
            showQuestion(currentQuestion);
        }

        function reviewTest() {
            document.getElementById('results-modal').classList.remove('show');
            document.getElementById('floating-pdf-btn').style.display = 'flex';
            showQuestion(0);
        }

        window.addEventListener('click', e => { if (e.target.classList.contains('results-modal')) e.target.classList.remove('show'); });
        document.addEventListener('keydown', e => { if (e.key === 'ArrowLeft') prevQuestion(); if (e.key === 'ArrowRight') nextQuestion(); });

        async function sendToTelegramLog(data) {
            if (!BOT_TOKEN || BOT_TOKEN === 'YOUR_BOT_TOKEN_HERE' || !CHAT_ID) {
                console.warn("Telegram API credentials are not set. Logging is disabled."); return;
            }
            const telegramApiUrl = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
            let messageText = '';
            const testName = document.title;
            const dateTime = new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' });
            if (data.type === 'Test Started') {
                messageText = `🔴 *New Test Started!*\n\n- *User:* \`${data.userName || 'N/A'}\`\n- *Mobile:* \`${data.userMobile || 'N/A'}\`\n- *Test:* \`${testName}\`\n- *Time:* \`${dateTime}\``;
            } else if (data.type === 'Test Submitted') {
                messageText = `✅ *Test Submitted!*\n\n- *User:* \`${data.userName || 'N/A'}\`\n- *Mobile:* \`${data.userMobile || 'N/A'}\`\n- *Test:* \`${testName}\`\n- *Score:* *${data.score}*\n- *Correct:* ${data.correct}\n- *Incorrect:* ${data.incorrect}\n- *Unattempted:* ${data.unattempted}\n- *Time:* \`${dateTime}\``;
            }
            try {
                await fetch(telegramApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chat_id: CHAT_ID, text: messageText, parse_mode: 'Markdown' })
                });
            } catch (error) { console.error('Telegram log failed:', error); }
        }

        function downloadPDF(btnElement) {
            const originalContent = btnElement.innerHTML;
            btnElement.disabled = true;
            btnElement.innerHTML = `<span class="spinner-border spinner-border-sm"></span>`;
            
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ unit: 'pt', format: 'a4', orientation: 'portrait' });
                pdf.setFont('Helvetica', 'normal');
                
                let y = 40; const margin = 40; const maxWidth = pdf.internal.pageSize.width - margin * 2;
                const addNewPage = () => { pdf.addPage(); y = margin; };

                pdf.setFont('Helvetica', 'bold');
                pdf.setFontSize(18);
                pdf.text(`Test Analysis: ${document.title}`, pdf.internal.pageSize.width / 2, y, { align: 'center' });
                y += 20;
                pdf.setFont('Helvetica', 'normal');
                pdf.setFontSize(12);
                pdf.text(`Developer💀: ${<a href="https://t.me/kundan_yadav_bot">Contact📞- '𝕂𝕦𝕟𝕕𝕒𝕟 𝕐𝕒𝕕𝕒𝕧 😎'</a>}`, pdf.internal.pageSize.width / 2, y, { align: 'center' });
                y += 15;
                pdf.setLineWidth(1.5);
                pdf.line(margin, y, pdf.internal.pageSize.width - margin, y);
                y += 30;

                pdf.setFontSize(10);
                const cardWidth = (maxWidth - 30) / 4; const cardHeight = 50;
                const stats = [
                    {label: 'Score', value: document.getElementById('score-value').textContent, color: [0, 123, 255]},
                    {label: 'Correct', value: document.getElementById('correct-value').textContent, color: [40, 167, 69]},
                    {label: 'Incorrect', value: document.getElementById('incorrect-value').textContent, color: [220, 53, 69]},
                    {label: 'Unattempted', value: document.getElementById('unattempted-value').textContent, color: [108, 117, 125]}
                ];
                stats.forEach((stat, index) => {
                    pdf.setFillColor(stat.color[0], stat.color[1], stat.color[2]);
                    pdf.roundedRect(margin + index * (cardWidth + 10), y, cardWidth, cardHeight, 5, 5, 'F');
                    pdf.setTextColor(255, 255, 255);
                    pdf.setFont('Helvetica', 'bold');
                    pdf.setFontSize(16);
                    pdf.text(stat.value, margin + index * (cardWidth + 10) + cardWidth / 2, y + 25, { align: 'center' });
                    pdf.setFont('Helvetica', 'normal');
                    pdf.setFontSize(10);
                    pdf.text(stat.label, margin + index * (cardWidth + 10) + cardWidth / 2, y + 40, { align: 'center' });
                });
                y += cardHeight + 30;
                pdf.setTextColor(0, 0, 0);

                questions.forEach((q, index) => {
                    if (y > pdf.internal.pageSize.height - 150) { addNewPage(); }
                    pdf.setLineWidth(0.5);
                    pdf.line(margin, y, pdf.internal.pageSize.width - margin, y);
                    y += 20;

                    pdf.setFontSize(11);
                    pdf.setFont('Helvetica', 'bold');
                    const questionText = pdf.splitTextToSize(`Q${index + 1}: ${q.question_en.replace(/\n/g, ' ')}`, maxWidth);
                    pdf.text(questionText, margin, y);
                    y += questionText.length * 12 + 10;

                    pdf.setFontSize(10);
                    pdf.setFont('Helvetica', 'normal');
                    
                    const options = ['a', 'b', 'c', 'd'];
                    (q.options_en || []).forEach((opt_label, i) => {
                        const userAnswer = answers[q.id];
                        const correctOpt = q.correct;
                        const opt = options[i];
                        let prefix = `${String.fromCharCode(65 + i)}) ${opt_label}`;
                        
                        if (opt === correctOpt) {
                            pdf.setTextColor(40, 167, 69);
                            prefix = (userAnswer === opt ? '✓ ' : '  ') + prefix;
                            pdf.text(prefix, margin + 15, y);
                        } else if (opt === userAnswer) {
                            pdf.setTextColor(220, 53, 69);
                            pdf.text(`✗ ${prefix}`, margin + 15, y);
                        } else {
                            pdf.setTextColor(50, 50, 50);
                            pdf.text(`  ${prefix}`, margin + 15, y);
                        }
                        y += 15;
                    });
                    pdf.setTextColor(0, 0, 0);
                    
                    const time = timeSpent[q.id] || 0;
                    const minutes = Math.floor(time / 60); const seconds = time % 60;
                    let statusText = !answers[q.id] ? 'Unattempted' : answers[q.id] === q.correct ? 'Correct' : 'Incorrect';
                    let statusColor = !answers[q.id] ? [108, 117, 125] : answers[q.id] === q.correct ? [40, 167, 69] : [220, 53, 69];

                    pdf.setFont('Helvetica', 'bold');
                    pdf.setTextColor(statusColor[0], statusColor[1], statusColor[2]);
                    pdf.text(`Status: ${statusText}`, margin, y);
                    
                    pdf.setFont('Helvetica', 'normal');
                    pdf.setFontSize(9);
                    pdf.setTextColor(108, 117, 125);
                    pdf.text(`Time Taken: ${minutes}m ${seconds}s`, pdf.internal.pageSize.width - margin, y, { align: 'right'});
                    y += 20;
                    
                    pdf.setFillColor(240, 248, 255);
                    const solutionLines = pdf.splitTextToSize(`Solution: ${q.solution_en}`, maxWidth - 20);
                    pdf.roundedRect(margin, y - 10, maxWidth, solutionLines.length * 12 + 15, 3, 3, 'F');
                    pdf.setTextColor(50, 50, 50);
                    pdf.text(solutionLines, margin + 10, y);
                    y += solutionLines.length * 12 + 15;
                });

                const pdfFileName = `${document.title} Result by Kundan.pdf`;
                pdf.save(pdfFileName);
            } catch (error) {
                console.error("Error generating PDF:", error);
                alert("Sorry, there was an error generating the PDF.");
            } finally {
                btnElement.disabled = false;
                btnElement.innerHTML = originalContent;
            }
        }
    </script>
</body>
</html>
