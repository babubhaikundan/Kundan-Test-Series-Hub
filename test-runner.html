<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading Test...</title>
    
    <!-- ==================== External Libraries ==================== -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- Confetti Library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        /* ==================== Root Variables & Dark Mode ==================== */
        :root{--primary:#007bff;--primary-light:#52a4ff;--primary-dark:#0056b3;--secondary:#6c757d;--accent:#ffc107;--success:#28a745;--danger:#dc3545;--light:#f8f9fa;--dark:#343a40;--gray:#6c757d;--light-gray:#dfe6e9;--card-bg:#fff;--body-bg:#f4f7fe;--header-bg:linear-gradient(135deg,var(--primary),var(--primary-dark));--footer-bg:#fff;--box-shadow:0 4px 20px rgba(0,0,0,.08);--transition:all .3s cubic-bezier(.25,.8,.25,1)}
        
        /* Dark mode colors override */
        body.dark-mode{--primary:#3498db; --light:#2c3e50;--dark:#ecf0f1;--gray:#95a5a6;--light-gray:#34495e;--card-bg:#1e272e;--body-bg:#141d26;--footer-bg:#1e272e;--box-shadow:0 4px 20px rgba(0,0,0,.3);--accent:#f1c40f}
        body.dark-mode .header {background: linear-gradient(135deg, var(--primary), #2980b9);}
        body.dark-mode .nav-btn {border-color: var(--primary);color: var(--primary);}
        body.dark-mode .option-input:checked+.option-label{background:rgba(0,123,255,.15)}
        body.dark-mode .solution-container, body.dark-mode .topic-analysis-container{background:rgba(0,123,255,.1)}
        body.dark-mode .review-mode .option-label.correct-answer{background:rgba(40,167,69,.1)}
        body.dark-mode .review-mode .option-input:checked+.option-label.incorrect{background:rgba(220,53,69,.1)}
        body.dark-mode .results-card{background:var(--card-bg)}
        body.dark-mode #user-details-modal .user-details-card .form-control{background-color:#34495e;color:#ecf0f1;border-color:#566573}
        body.dark-mode #user-details-modal .user-details-card .form-control::placeholder{color:#95a5a6}
        body.dark-mode .filter-btn{background:var(--light-gray);color:var(--dark)}
        body.dark-mode .filter-btn.active{background:var(--primary);color:#fff}
        
        /* ==================== Global & Body Styles ==================== */
        *{-webkit-tap-highlight-color:transparent}
        body{background-color:var(--body-bg);font-family:Poppins,'Noto Sans Devanagari',sans-serif;color:var(--dark);line-height:1.6;overflow-x:hidden;transition:background-color .3s,color .3s}
        body:not(.welcome-mode){padding-top:60px;padding-bottom:80px}

        /* ==================== Welcome Screen ==================== */
        #welcome-screen{position:fixed;top:0;left:0;width:100%;height:100%;z-index:1200;display:flex;align-items:center;justify-content:center;padding:16px;overflow:hidden;background-size:cover;background-position:center center}
        #welcome-screen::before{content:'';position:absolute;top:-10px;left:-10px;right:-10px;bottom:-10px;z-index:-1;background:linear-gradient(rgba(29,36,47,.7),rgba(29,36,47,.7));backdrop-filter:blur(3px);-webkit-backdrop-filter:blur(3px)}
        .welcome-card{background:rgba(255,255,255,.1);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(15px);border:1px solid rgba(255,255,255,.2);border-radius:20px;padding:32px;width:100%;max-width:500px;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,.2);animation:fadeInUp .8s cubic-bezier(.25,.8,.25,1) forwards}
        @keyframes fadeInUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
        .welcome-icon{font-size:3rem;color:#fff;margin-bottom:16px;text-shadow:0 2px 10px rgba(0,0,0,.2)}
        .welcome-card h3{font-weight:700;font-size:1.8rem;color:#fff;margin-bottom:8px;text-shadow:0 1px 5px rgba(0,0,0,.2)}
        .welcome-branding a{color:rgba(255,255,255,.8);font-size:1.1rem;font-weight:500;text-decoration:none;margin-bottom:32px;display:inline-block;transition:var(--transition)}
        .welcome-branding a:hover{color:#fff}
        .welcome-branding .kundan-font{font-weight:600;color:#ff0}
        .welcome-stats{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-bottom:32px}
        .stat-item{background:rgba(255,255,255,.1);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,.2)}
        .stat-item .icon{font-size:1.5rem;color:#fff;margin-bottom:8px}
        .stat-item .value{font-size:1.4rem;font-weight:600;color:#fff}
        .stat-item .label{font-size:.85rem;color:rgba(255,255,255,.7);font-weight:500}
        #start-test-btn{width:100%;padding:14px;font-size:1.1rem;font-weight:600;border-radius:12px;animation:pulse 2s infinite}
        @keyframes pulse{0%{transform:scale(1);box-shadow:0 0 0 0 rgba(0,123,255,.4)}70%{transform:scale(1.02);box-shadow:0 0 0 10px rgba(0,123,255,0)}100%{transform:scale(1);box-shadow:0 0 0 0 rgba(0,123,255,0)}}
        
        /* ==================== Toast Notification ==================== */
        .toast-notification {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark);
            color: #fff;
            padding: 12px 24px;
            border-radius: 50px;
            z-index: 9999;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .toast-notification i {
            font-size: 1.1rem;
        }
        .toast-notification.success {
            background: var(--success);
        }
        .toast-notification.error {
            background: var(--danger);
        }
        .toast-notification.warning {
            background: var(--accent);
            color: var(--dark);
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        
        /* ==================== Main Test UI: Header & Footer ==================== */
        .header{position:fixed;top:0;left:0;right:0;height:60px;background:var(--header-bg);color:#fff;display:flex;align-items:center;padding:0 16px;z-index:1000;box-shadow:0 2px 10px rgba(0,0,0,.1)}
        .header-content{display:flex;justify-content:space-between;align-items:center;width:100%;gap:8px}
        .header-brand{display:flex;align-items:center;font-weight:600;color:#fff;text-decoration:none;flex:1 1 0;min-width:0}
        .header-brand i{margin-right:8px;font-size:1.2rem;flex-shrink:0}
        .header-brand span { white-space: normal; line-height: 1.2; font-size: 0.85rem; }
        .header-controls{display:flex;align-items:center;gap:8px;flex-shrink:0}
        .control-btn{width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,.1);border:none;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:var(--transition);flex-shrink:0}
        .control-btn:hover{background:rgba(255,255,255,.2)}
        .control-btn.active{background:rgba(255,255,255,.3);transform:scale(1.1)}
        
        /* Submit button styling */
        .submit-btn-header{height:34px;padding:0 10px;font-size:0.8rem;border-radius:17px}
        .submit-btn-header.submitted-state{padding:0;width:34px;background-color:var(--success);border-color:var(--success);cursor:default}
        
        /* Timer warning animation */
        @keyframes blink-animation {
            0% { background-color: var(--danger); transform: scale(1); box-shadow: 0 0 5px var(--danger); }
            50% { background-color: #ff7675; transform: scale(1.05); box-shadow: 0 0 15px #ff7675; }
            100% { background-color: var(--danger); transform: scale(1); box-shadow: 0 0 5px var(--danger); }
        }
        .submit-btn-header.blinking {
            animation: blink-animation 1.5s infinite;
            border-color: #fff;
            color: #fff;
        }
        .submit-btn-header:hover:not(.submitted-state){background:rgba(255,255,255,.25)}
        .timer-display{background:rgba(0,0,0,.2);border-radius:18px;padding:4px 10px;font-size:.8rem;font-weight:500;display:flex;align-items:center;flex-shrink:0}
        .timer-display i{margin-right:6px}
        
        /* Bottom Navigation */
        .bottom-nav{position:fixed;bottom:0;left:0;right:0;height:80px;background:var(--footer-bg);box-shadow:0 -2px 10px rgba(0,0,0,.1);display:flex;align-items:center;justify-content:space-between;padding:0 16px;z-index:800;transition:background-color .3s}
        .nav-btn{height:48px;border-radius:12px;border:1px solid var(--primary);font-weight:500;display:flex;align-items:center;justify-content:center;padding:0 20px;transition:var(--transition);gap:8px;background:0 0;color:var(--primary);flex-shrink:0}
        #inline-mark-btn { height: 40px; padding: 0 8px; font-size: 0.8rem; flex-grow: 1; margin: 0 8px; border-color: var(--secondary); color: var(--secondary); max-width: 100px; }
        #inline-mark-btn.marked { border-color: var(--accent); color: var(--accent); font-weight: 600; }
        
        /* Desktop Footer */
        .desktop-footer{position:fixed;bottom:0;left:0;right:320px;height:40px;background:var(--dark);color:#fff;align-items:center;justify-content:center;z-index:850;display:none}
        .desktop-footer.show{display:flex}
        .desktop-footer a{color:#fff;text-decoration:none;font-weight:500}
        .desktop-footer a:hover{color:var(--accent)}
        
        /* ==================== Section Tabs ==================== */
        #section-tabs-container { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 8px; }
        .section-tab { padding: 8px 16px; border-radius: 50px; background: var(--light-gray); color: var(--secondary); font-weight: 500; cursor: pointer; transition: all 0.3s; white-space: nowrap; border: none; }
        .section-tab.active {
            background: #e67919;
            color: #fff;
            box-shadow: 0 2px 8px rgba(230, 126, 34, 0.4);
        }
        body.dark-mode .section-tab.active {
            background: #803300;
            color: #f0f0f0;
            box-shadow: 0 2px 8px rgba(211, 84, 0, 0.2);
        }
                        
        /* ==================== Main Test UI: Question & Options ==================== */
        .main-content{padding:16px;padding-bottom: 20px;}
        .question-card,.results-card,.question-nav{background:var(--card-bg);transition:background-color .3s}
        .question-card{border-radius:16px;padding:20px;margin-bottom:16px;box-shadow:0 2px 10px rgba(0,0,0,.05);border:1px solid transparent;overflow:hidden}
        .question-counter{font-size:.9rem;color:var(--gray);text-align:center;margin-bottom:16px;font-weight:500}
        .question-text{font-size:1.1rem;line-height:1.6;margin-bottom:20px;color:var(--dark);overflow-wrap:break-word;word-wrap:break-word}
        .question-image-container { text-align: center; margin-bottom: 20px; }
        .question-image { max-width: 100%; max-height: 250px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,.1); }
        
        /* Language toggle */
        .lang-toggle-container{display:flex;justify-content:center;margin-bottom:20px;background-color:var(--light-gray);border-radius:12px;padding:4px}
        .lang-toggle-btn{flex:1;text-align:center;padding:8px 12px;border:none;background:0 0;cursor:pointer;border-radius:10px;font-weight:500;color:var(--secondary);transition:all .3s ease}
        .lang-toggle-btn.active{background-color:var(--card-bg);color:var(--primary);box-shadow:0 2px 5px rgba(0,0,0,.1)}
        body.dark-mode .lang-toggle-btn.active{background-color:#000;color:#fff;box-shadow:0 2px 5px rgba(0,0,0,.3)}
        
        /* Options styling */
        .option-item{margin-bottom:12px;position:relative}
        .option-input{position:absolute;opacity:0;width:0;height:0}
        .option-label{display:block;padding:14px 16px;background:var(--card-bg);border:1px solid var(--light-gray);border-radius:12px;cursor:pointer;transition:var(--transition);position:relative;overflow:hidden}
        .option-label:hover{border-color:var(--primary-light);transform:translateY(-2px);box-shadow:0 2px 10px rgba(0,0,0,.05)}
        .option-input:checked+.option-label{border-color:var(--primary);box-shadow:0 0 0 1px var(--primary)}
        .option-input:checked+.option-label::after{content:'';position:absolute;top:0;left:0;width:3px;height:100%;background:var(--primary)}
        
        /* Review mode colors */
        .review-mode .option-label.correct-answer{border-color:var(--success);background:rgba(40,167,69,.05)}
        .review-mode .option-label.correct-answer::after{background:var(--success)}
        .review-mode .option-input:checked+.option-label.incorrect{border-color:var(--danger);background:rgba(220,53,69,.05)}
        .review-mode .option-input:checked+.option-label.incorrect::after{background:var(--danger)}
        
        /* Solution container */
        .solution-container, .topic-analysis-container{margin-top:20px;padding:16px;border-radius:12px;border-left:3px solid var(--primary)}
        .solution-title{font-weight:600;margin-bottom:8px;color:var(--primary)}
        .time-taken-info{font-size:.8rem;color:var(--secondary);font-style:italic;margin-top:10px}
        
        /* ==================== Question Navigator (Sidebar) ==================== */
        .question-nav{position:fixed;top:60px;right:0;bottom:0;width:100%;max-width:320px;box-shadow:-5px 0 15px rgba(0,0,0,.1);transform:translateX(100%);transition:var(--transition);z-index:900;overflow-y:auto;padding:16px}
        .question-nav.show{transform:translateX(0)}
        .nav-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .nav-title{font-weight:600;font-size:1.1rem;margin:0}
        .nav-section-title { font-weight: 600; color: var(--primary); margin-top: 16px; margin-bottom: 8px; font-size: 0.9rem; }
        
        /* Question Filter Buttons */
        .filter-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        .filter-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            background: var(--light-gray);
            color: var(--secondary);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        .filter-btn.active {
            background: var(--primary);
            color: #fff;
            box-shadow: 0 2px 8px rgba(0,123,255,0.3);
        }
        .filter-btn i {
            margin-right: 4px;
        }
        
        /* Question boxes grid */
        .question-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(40px,1fr));gap:8px}
        .q-box{width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:10px;cursor:pointer;font-weight:500;border:1px solid var(--light-gray);background:var(--card-bg);transition:var(--transition)}
        .q-box.attempted{background-color:var(--primary);color:#fff;border-color:var(--primary)}
        .q-box.correct{background-color:var(--success);color:#fff;border-color:var(--success)}
        .q-box.incorrect{background-color:var(--danger);color:#fff;border-color:var(--danger)}
        .q-box.current{transform:scale(1.1); box-shadow: 0 0 10px var(--accent);}
        .q-box.unattempted{background-color:var(--gray);color:#fff;border-color:var(--gray)}
        .q-box.marked { background-color: var(--accent); color: var(--dark); border-color: var(--accent); font-weight: 600; }
        .q-box.attempted.marked { background-color: var(--primary); border: 2px solid var(--accent); }

        /* Overlay */
        .nav-overlay{position:fixed;top:60px;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:890;opacity:0;pointer-events:none;transition:var(--transition)}
        .nav-overlay.show{opacity:1;pointer-events:all}
        
        /* ==================== Modals & Other Components ==================== */
        .results-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:1100;opacity:0;pointer-events:none;transition:var(--transition);padding:16px; overflow-y: auto;}
        .results-modal.show{opacity:1;pointer-events:all}
        .results-card{border-radius:20px;width:100%;max-width:500px;padding:20px;text-align:center; margin: auto;}
        .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;margin-top:1rem;margin-bottom:1.5rem}
        .stat-card{color:#fff;padding:1rem;border-radius:12px}
        .stat-value{font-size:2rem;font-weight:600}
        .stat-label{font-size:.9rem}
        .results-footer{display:flex;justify-content:center;gap:16px}
        
        /* User details modal */
        #user-details-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:1250;display:flex;align-items:center;justify-content:center;padding:16px;opacity:0;pointer-events:none;transition:opacity .3s ease-in-out}
        #user-details-modal.show{opacity:1;pointer-events:all}
        .user-details-card{background:var(--card-bg);border-radius:20px;padding:32px;width:100%;max-width:450px;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,.3);transform:translateY(20px);opacity:0;animation:fadeInScale .3s forwards}
        @keyframes fadeInScale{from{opacity:0;transform:translateY(20px) scale(.95)}to{opacity:1;transform:translateY(0) scale(1)}}
        .user-details-card h4{font-weight:600;margin-bottom:24px;color:var(--dark)}
        .user-details-card .form-group{margin-bottom:15px;text-align:left}
        .user-details-card .form-control{width:100%;padding:12px;border:1px solid var(--light-gray);border-radius:8px;font-size:1rem;color:var(--dark);background-color:var(--body-bg);transition:border-color .3s,box-shadow .3s}
        .user-details-card .form-control:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(0,123,255,.25);outline:none}
        .user-details-card .btn-proceed{width:100%;padding:12px;font-size:1rem;font-weight:500;border-radius:10px;margin-top:20px}
        
        /* PDF generating overlay */
        .pdf-generating-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.75);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-family: 'Poppins', sans-serif;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }
        
        /* Floating PDF button */
        #floating-pdf-btn{position:fixed;bottom:100px;right:20px;width:60px;height:60px;border-radius:50%;background-color:var(--success);color:#fff;border:none;box-shadow:0 4px 15px rgba(0,0,0,.2);display:none;align-items:center;justify-content:center;font-size:1.5rem;z-index:1050;transition:var(--transition)}
        #floating-pdf-btn:hover{transform:scale(1.1);background-color:#218838}
        
        /* Keyboard Shortcuts Help */
        .shortcuts-help {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--card-bg);
            padding: 12px 16px;
            border-radius: 12px;
            box-shadow: var(--box-shadow);
            font-size: 0.85rem;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .shortcuts-help.show {
            opacity: 1;
            pointer-events: all;
        }
        .shortcuts-help h6 {
            margin: 0 0 8px 0;
            font-weight: 600;
            color: var(--primary);
        }
        .shortcuts-help ul {
            margin: 0;
            padding: 0;
            list-style: none;
        }
        .shortcuts-help li {
            margin: 4px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .shortcuts-help kbd {
            background: var(--light-gray);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.8rem;
        }
        
        /* ==================== Responsive Design ==================== */
        @media (min-width:992px){.main-content{margin-right:320px}.question-nav{transform:translateX(0);bottom:40px}.bottom-nav{display:none}#floating-pdf-btn{right:340px;bottom:60px}}
        @media (max-width:991.98px){.desktop-footer{display:none!important}.question-nav{bottom:80px}.shortcuts-help{display:none !important;}}
    </style>
</head>
<body class="welcome-mode">
    
    <!-- ==================== Welcome Screen ==================== -->
    <div id="welcome-screen">
        <div class="welcome-card">
            <div class="welcome-icon"><i class="fas fa-brain"></i></div>
            <h3 id="welcome-title">Loading Test...</h3>
            <div class="welcome-branding"><a href="https://t.me/kundan_yadav_bot" target="_blank">By: <span class="kundan-font">ùïÇùï¶ùïüùïïùïíùïü ùïêùïíùïïùïíùïß üòé</span></a></div>
            
            <div class="welcome-stats">
                <div class="stat-item"><div class="icon"><i class="fas fa-list-ol"></i></div><div class="value" id="welcome-q-count">--</div><div class="label">Questions</div></div>
                <div class="stat-item"><div class="icon"><i class="fas fa-star"></i></div><div class="value" id="welcome-marks">--</div><div class="label">Total Marks</div></div>
                <div class="stat-item"><div class="icon"><i class="far fa-clock"></i></div><div class="value" id="welcome-time">--:--</div><div class="label">Time</div></div>
                <div class="stat-item"><div class="icon"><i class="fas fa-pen-fancy"></i></div><div class="value" style="color: var(--success);" id="welcome-marking">--</div><div class="label">Marking Scheme</div></div>
            </div>
            
            <div id="start-area"></div>
        </div>
    </div>

    <!-- ==================== User Details Modal ==================== -->
    <div id="user-details-modal">
        <div class="user-details-card">
            <h4>Enter Your Details</h4>
            <div class="form-group"><input type="text" id="user-name-input" class="form-control" placeholder="Your Name" required></div>
            <div class="form-group"><input type="tel" id="user-mobile-input" class="form-control" placeholder="Mobile Number" required pattern="[0-9]{10}" title="Please enter a 10-digit mobile number"></div>
            <button class="btn btn-primary btn-proceed" onclick="proceedToTest()">Proceed to Test</button>
        </div>
    </div>

    <!-- ==================== Main Test Container ==================== -->
    <div id="test-container" style="display: none;">
        
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <a href="https://t.me/kundan_yadav_bot" target="_blank" class="header-brand">
                    <i class="fas fa-brain"></i>
                    <span id="header-title">Test</span>
                </a>
                <div class="header-controls">
                    <div class="timer-display"><i class="far fa-clock"></i><span id="timer-display">00:00</span></div>
                    <!-- Fullscreen Toggle Button -->
                    <button id="fullscreen-btn" class="control-btn" onclick="toggleFullscreen()" title="Toggle Fullscreen (F)"><i class="fas fa-expand"></i></button>
                    <!-- Theme Toggle Button -->
                    <button id="theme-toggle-btn" class="control-btn" onclick="toggleTheme()" title="Toggle Theme"><i class="fas fa-moon"></i></button>
                    <!-- Keyboard Shortcuts Help Button -->
                    <button id="shortcuts-btn" class="control-btn" onclick="toggleShortcutsHelp()" title="Keyboard Shortcuts (?)"><i class="fas fa-keyboard"></i></button>
                    <!-- Submit Button -->
                    <button id="submit-btn-header" class="submit-btn-header" onclick="confirmSubmit()">Submit</button>
                    <!-- Navigator Toggle (mobile only) -->
                    <button class="control-btn nav-toggle-btn d-lg-none" onclick="toggleNav()"><i class="fas fa-th"></i></button>
                </div>
            </div>
        </header>
        
        <!-- Main Content Area -->
        <main class="main-content">
            <div id="section-tabs-container"></div>
            <div class="question-counter" id="question-counter">Question 1 of --</div>
            <div id="questions-container"></div>
        </main>
        
        <!-- Question Navigator (Sidebar) -->
        <aside class="question-nav" id="question-nav">
            <div class="nav-header">
                <h3 class="nav-title">Questions</h3>
                <div class="question-stats">
                    <span class="badge bg-primary" id="attempted-count">0</span>
                    <span class="badge bg-secondary" id="total-count">--</span>
                    <button class="control-btn d-lg-none" onclick="toggleNav(false)" style="color:var(--dark); background:var(--light-gray);"><i class="fas fa-times"></i></button>
                </div>
            </div>
            
            <!-- Question Filter Buttons -->
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all" onclick="filterQuestions('all')">
                    <i class="fas fa-list"></i> All
                </button>
                <button class="filter-btn" data-filter="attempted" onclick="filterQuestions('attempted')">
                    <i class="fas fa-check"></i> Attempted
                </button>
                <button class="filter-btn" data-filter="unattempted" onclick="filterQuestions('unattempted')">
                    <i class="fas fa-circle"></i> Unattempted
                </button>
                <button class="filter-btn" data-filter="marked" onclick="filterQuestions('marked')">
                    <i class="fas fa-flag"></i> Marked
                </button>
            </div>
            
            <div id="question-palette"></div>
        </aside>
        
        <!-- Overlay -->
        <div class="nav-overlay" id="nav-overlay" onclick="toggleNav(false)"></div>
        
        <!-- Bottom Navigation (Mobile) -->
        <nav class="bottom-nav d-lg-none">
            <button class="nav-btn" onclick="prevQuestion()"><i class="fas fa-chevron-left"></i> Prev</button>
            <button id="inline-mark-btn" class="nav-btn" onclick="markQuestionForReview()">
                <i class="far fa-flag"></i> Mark
            </button>
            <button class="nav-btn" onclick="nextQuestion()">Next <i class="fas fa-chevron-right"></i></button>
        </nav>
        
        <!-- Desktop Footer -->
        <footer class="desktop-footer" id="desktop-branding"><a href="https://t.me/kundan_yadav_bot" target="_blank">Contact- ùïÇùï¶ùïüùïïùïíùïü ùïêùïíùïïùïíùïß üòé</a></footer>
        
        <!-- Keyboard Shortcuts Help Panel -->
        <div class="shortcuts-help" id="shortcuts-help">
            <h6><i class="fas fa-keyboard"></i> Keyboard Shortcuts</h6>
            <ul>
                <li><kbd>‚Üê</kbd> <kbd>‚Üí</kbd> Navigate</li>
                <li><kbd>1-4</kbd> Select Option</li>
                <li><kbd>M</kbd> Mark for Review</li>
                <li><kbd>S</kbd> Submit Test</li>
                <li><kbd>F</kbd> Fullscreen</li>
                <li><kbd>?</kbd> Toggle This Help</li>
            </ul>
        </div>
    </div>

    <!-- ==================== Results Modal ==================== -->
    <div class="results-modal" id="results-modal">
        <div class="results-card">
            <h3>Test Results</h3>
            <div class="stats-grid">
                <div class="stat-card" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark))"><div class="stat-value" id="score-value">0</div><div class="stat-label">Score</div></div>
                <div class="stat-card" style="background: linear-gradient(135deg, var(--success), #1b9aaa)"><div class="stat-value" id="correct-value">0</div><div class="stat-label">Correct</div></div>
                <div class="stat-card" style="background: linear-gradient(135deg, var(--danger), #e84393)"><div class="stat-value" id="incorrect-value">0</div><div class="stat-label">Incorrect</div></div>
                <div class="stat-card" style="background: linear-gradient(135deg, var(--gray), var(--dark))"><div class="stat-value" id="unattempted-value">0</div><div class="stat-label">Unattempted</div></div>
            </div>
            <div id="topic-analysis-chart-container" style="margin-bottom: 20px;">
                <canvas id="topicAnalysisChart"></canvas>
            </div>
            <div class="results-footer"><button class="nav-btn btn btn-primary" onclick="reviewTest()"><i class="fas fa-search me-1"></i> Review</button></div>
        </div>
    </div>
    
    <!-- Floating PDF Button -->
    <button id="floating-pdf-btn" onclick="downloadPDF(this)" title="Download PDF Report"><i class="fas fa-file-pdf"></i></button>

    <script>
        /* ==================== CONFIGURATION & GLOBAL VARIABLES ==================== */
        
        // ===== Telegram Configuration =====
        // Token ko base64 encoded format me store kiya gaya hai (security ke liye)
        const BOT_TOKEN_ENCODED = 'ODMzODkxMTgzODpBQUc1cVRpeFRReXVuNGt0U1V1ZnhnT2YxUkRMMjVGaElXWQ==';
        const CHAT_ID = '-1003340893424';      // Telegram group ID
        const TOPIC_ID = '19';                  // Group topic ID jaha messages jayenge
        
        /**
         * Base64 se token decode karta hai
         * @param {string} encodedToken - Base64 encoded token
         * @returns {string|null} Decoded token ya null agar error ho
         */
        const decodeToken = (encodedToken) => {
            try {
                return atob(encodedToken);
            } catch (e) {
                console.error("Token decode failed:", e);
                return null;
            }
        };
        
        // ===== User & Test Variables =====
        let userName = '';                      // User ka naam
        let userMobile = '';                    // User ka mobile number
        let testTitle = '';                     // Test ka title
        
        // ===== Test Data Variables =====
        let sections = [];                      // Test sections array
        let questions = [];                     // Sabhi questions ka array
        let totalQuestions = 0;                 // Total questions count
        
        // ===== Test State Variables =====
        let currentLang = "en";                 // Current language (en/hi)
        let currentQuestion = 0;                // Current question index
        let answers = {};                       // User ke answers
        let submitted = false;                  // Test submit hua ya nahi
        let testStarted = false;                // Test start hua ya nahi
        
        // ===== Timing Variables =====
        let totalTime = 0;                      // Total test time (in seconds)
        let timeSpent = {};                     // Each question par time
        let timerInterval;                      // Main timer interval
        let questionTimer;                      // Current question timer
        let timeOnCurrentQuestion = 0;          // Current question par time
        
        // ===== Additional Features =====
        let markedForReview = {};               // Mark for review
        let topicAnalysis = {};                 // Topic-wise performance
        let currentFilter = 'all';              // Current question filter
        let soundsEnabled = true;               // Sound alerts enabled/disabled
        
        // ===== UI Assets =====
        const backgroundImages = [
            'https://s.tfrbot.com/h/r8dCRJ', 
            'https://s.tfrbot.com/h/sRMf7S', 
            'https://s.tfrbot.com/h/Vf6F3e', 
            'https://s.tfrbot.com/h/BEnHxJ'
        ];
        
        /* ==================== INITIALIZATION & EVENT LISTENERS ==================== */
        
        /**
         * Window load hone par initialization
         */
        window.onload = function() { 
            setRandomBackground();
            
            loadTest().then(() => {
                initializeTest(); 
                if (loadProgress()) return; 
                
                handleResize(); 
                window.addEventListener('resize', handleResize);
                
                history.replaceState({page: 'instructions'}, 'Instructions', '#instructions'); 
                window.addEventListener('popstate', popStateHandler); 
                
                // Dark mode preference load
                if (localStorage.getItem('theme') === 'dark') {
                    document.body.classList.add('dark-mode');
                    const themeIcon = document.querySelector('#theme-toggle-btn i');
                    if(themeIcon) { 
                        themeIcon.classList.remove('fa-moon'); 
                        themeIcon.classList.add('fa-sun'); 
                    }
                }
                
                // Fullscreen change listener
                document.addEventListener('fullscreenchange', updateFullscreenIcon);
                
            }).catch(error => {
                console.error("Initialization failed:", error);
                document.getElementById('welcome-title').textContent = 'Error Loading Test';
                document.getElementById('start-area').innerHTML = `<p style="color: #ffdddd;">${error.message}</p>`;
            });
        };
        
        /**
         * Browser tab close warning
         */
        const beforeUnloadHandler = (e) => { 
            if (testStarted && !submitted) { 
                e.preventDefault(); 
                e.returnValue = 'Are you sure you want to leave? Your progress will be lost.'; 
            } 
        };
        
        /**
         * Browser back button handling
         */
        const popStateHandler = (event) => { 
            if (testStarted && !submitted && event.state && event.state.page === 'instructions') { 
                const exitConfirm = confirm("Are you sure you want to exit the test? Your progress will not be saved."); 
                if (exitConfirm) { 
                    location.reload(); 
                } else { 
                    history.pushState({page: 'test'}, 'Test In Progress', '#test'); 
                } 
            } else if (event.state && event.state.page === 'test') { 
                showTestUI(); 
            } else { 
                showWelcomeUI(); 
            } 
        };
        
        /* ==================== KEYBOARD SHORTCUTS ==================== */
        
        /**
         * Keyboard shortcuts handler
         * Features:
         * - Arrow keys: Navigate questions
         * - 1-4: Select options
         * - M: Mark for review
         * - S: Submit
         * - F: Fullscreen
         * - ?: Toggle shortcuts help
         */
        document.addEventListener('keydown', (e) => {
            // Shortcuts sirf test mode me active
            if (!testStarted || submitted) return;
            
            // Input fields me type karte waqt shortcuts disable
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            // Arrow keys - Navigation
            if (e.key === 'ArrowLeft') {
                e.preventDefault();
                prevQuestion();
            }
            if (e.key === 'ArrowRight') {
                e.preventDefault();
                nextQuestion();
            }
            
            // Number keys 1-4 - Select options
            if (e.key >= '1' && e.key <= '4') {
                e.preventDefault();
                const options = ['a', 'b', 'c', 'd'];
                const selectedOption = options[parseInt(e.key) - 1];
                selectAnswer(questions[currentQuestion].id, selectedOption);
                
                // Radio button ko bhi check karo visually
                const radioBtn = document.getElementById(`opt-${currentQuestion}-${selectedOption}`);
                if (radioBtn) radioBtn.checked = true;
                
                showQuestion(currentQuestion); // Refresh to show selection
            }
            
            // M - Mark for review
            if (e.key.toLowerCase() === 'm') {
                e.preventDefault();
                markQuestionForReview();
            }
            
            // S - Submit test
            if (e.key.toLowerCase() === 's') {
                e.preventDefault();
                confirmSubmit();
            }
            
            // F - Fullscreen toggle
            if (e.key.toLowerCase() === 'f') {
                e.preventDefault();
                toggleFullscreen();
            }
            
            // ? - Toggle shortcuts help
            if (e.key === '?') {
                e.preventDefault();
                toggleShortcutsHelp();
            }
        });
        
        /**
         * Shortcuts help panel toggle
         */
        function toggleShortcutsHelp() {
            const helpPanel = document.getElementById('shortcuts-help');
            const btn = document.getElementById('shortcuts-btn');
            
            if (helpPanel.classList.contains('show')) {
                helpPanel.classList.remove('show');
                btn.classList.remove('active');
            } else {
                helpPanel.classList.add('show');
                btn.classList.add('active');
                
                // 5 seconds baad auto-hide
                setTimeout(() => {
                    helpPanel.classList.remove('show');
                    btn.classList.remove('active');
                }, 5000);
            }
        }
        
        /* ==================== TOAST NOTIFICATION SYSTEM ==================== */
        
        /**
         * Toast notification dikhata hai
         * @param {string} message - Message text
         * @param {string} type - Type: 'success', 'error', 'warning', 'info'
         * @param {number} duration - Duration in milliseconds
         */
        function showToast(message, type = 'info', duration = 2000) {
            const toast = document.createElement('div');
            toast.className = `toast-notification ${type}`;
            
            // Icon add karo type ke according
            let icon = '';
            switch(type) {
                case 'success': icon = '<i class="fas fa-check-circle"></i>'; break;
                case 'error': icon = '<i class="fas fa-times-circle"></i>'; break;
                case 'warning': icon = '<i class="fas fa-exclamation-triangle"></i>'; break;
                default: icon = '<i class="fas fa-info-circle"></i>';
            }
            
            toast.innerHTML = `${icon}<span>${message}</span>`;
            document.body.appendChild(toast);
            
            // Duration ke baad remove
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
        
        /* ==================== FULLSCREEN MODE ==================== */
        
        /**
         * Fullscreen mode toggle karta hai
         */
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                // Fullscreen request
                document.documentElement.requestFullscreen().then(() => {
                    showToast('Fullscreen mode activated', 'success', 1500);
                }).catch(err => {
                    console.error('Fullscreen request failed:', err);
                    showToast('Fullscreen not available', 'error', 1500);
                });
            } else {
                // Exit fullscreen
                document.exitFullscreen().then(() => {
                    showToast('Fullscreen mode deactivated', 'info', 1500);
                });
            }
        }
        
        /**
         * Fullscreen icon update karta hai
         */
        function updateFullscreenIcon() {
            const btn = document.getElementById('fullscreen-btn');
            const icon = btn.querySelector('i');
            
            if (document.fullscreenElement) {
                icon.classList.remove('fa-expand');
                icon.classList.add('fa-compress');
                btn.classList.add('active');
            } else {
                icon.classList.remove('fa-compress');
                icon.classList.add('fa-expand');
                btn.classList.remove('active');
            }
        }
        
        /* ==================== SOUND ALERTS ==================== */
        
        /**
         * Alert sound play karta hai
         * @param {string} type - 'warning' ya 'success'
         */
        function playAlertSound(type = 'warning') {
            if (!soundsEnabled) return;
            
            try {
                // Simple beep sound using Web Audio API
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                if (type === 'warning') {
                    oscillator.frequency.value = 800; // High pitch for warning
                    gainNode.gain.value = 0.3;
                } else {
                    oscillator.frequency.value = 523.25; // C5 note for success
                    gainNode.gain.value = 0.2;
                }
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (e) {
                console.log('Sound play failed:', e);
            }
        }
        
        /**
         * Vibration trigger karta hai (mobile devices)
         * @param {Array} pattern - Vibration pattern
         */
        function triggerVibration(pattern = [200, 100, 200]) {
            if (navigator.vibrate) {
                navigator.vibrate(pattern);
            }
        }
        
        /* ==================== QUESTION FILTER ==================== */
        
        /**
         * Question palette me filter apply karta hai
         * @param {string} filterType - 'all', 'attempted', 'unattempted', 'marked'
         */
        function filterQuestions(filterType) {
            currentFilter = filterType;
            
            // Filter buttons update
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.dataset.filter === filterType) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Question boxes filter
            document.querySelectorAll('.q-box').forEach((box, idx) => {
                const qId = questions[idx].id;
                let shouldShow = true;
                
                switch(filterType) {
                    case 'attempted':
                        shouldShow = !!answers[qId];
                        break;
                    case 'unattempted':
                        shouldShow = !answers[qId];
                        break;
                    case 'marked':
                        shouldShow = !!markedForReview[qId];
                        break;
                    case 'all':
                    default:
                        shouldShow = true;
                }
                
                box.style.display = shouldShow ? 'flex' : 'none';
            });
            
            // Toast notification
            const filterNames = {
                'all': 'All Questions',
                'attempted': 'Attempted',
                'unattempted': 'Unattempted',
                'marked': 'Marked for Review'
            };
            showToast(`Filter: ${filterNames[filterType]}`, 'info', 1500);
        }
        
        /* ==================== UI CONTROL FUNCTIONS ==================== */
        
        function showWelcomeUI(){
            document.getElementById('welcome-screen').style.display='flex';
            document.getElementById('test-container').style.display='none';
            document.body.classList.add('welcome-mode');
            document.getElementById('floating-pdf-btn').style.display='none';
            document.getElementById('user-details-modal').classList.remove('show');
        }
        
        function showTestUI(){
            document.getElementById('welcome-screen').style.display='none';
            document.getElementById('test-container').style.display='block';
            document.body.classList.remove('welcome-mode');
        }
        
        function showUserDetailsPopup(){
            document.getElementById('user-details-modal').classList.add('show');
            document.body.style.overflow='hidden';
            document.getElementById('user-name-input').value=localStorage.getItem('userName')||'';
            document.getElementById('user-mobile-input').value=localStorage.getItem('userMobile')||'';
        }
        
        function toggleTheme(){
            const body = document.body;
            body.classList.toggle('dark-mode');
            const icon = document.querySelector('#theme-toggle-btn i');
            
            if(body.classList.contains('dark-mode')){
                localStorage.setItem('theme','dark');
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
                showToast('Dark mode activated', 'success', 1500);
            } else {
                localStorage.setItem('theme','light');
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
                showToast('Light mode activated', 'success', 1500);
            }
        }
        
        function handleResize(){
            const nav = document.getElementById('question-nav');
            if(window.innerWidth >= 992){
                nav.classList.add('show');
            } else {
                nav.classList.remove('show');
            }
        }
        
        function setRandomBackground(){
            const welcomeScreen = document.getElementById('welcome-screen');
            const randomIndex = Math.floor(Math.random()*backgroundImages.length);
            welcomeScreen.style.backgroundImage = `url('${backgroundImages[randomIndex]}')`;
        }

        /* ==================== TEST DATA & SETUP ==================== */
        
        /**
         * Test JSON file load karta hai
         */
        async function loadTest() {
            try{
                const urlParams = new URLSearchParams(window.location.search);
                const testId = urlParams.get('test');
                
                if (!testId) throw new Error("No test ID provided in the URL.");
                
                const response = await fetch(`tests/${testId}.json?t=${new Date().getTime()}`);
                if (!response.ok) throw new Error(`Could not load data file: tests/${testId}.json`);
                
                const testData = await response.json();
                
                sections = testData.sections || [{ name: "General", questions: testData.questions }];
                questions = sections.flatMap(s => s.questions);
                totalQuestions = questions.length;
                totalTime = testData.time * 60;
                testTitle = testData.title;
                
                // UI updates
                document.title = testTitle;
                document.getElementById('welcome-title').textContent = testTitle;
                document.getElementById('header-title').textContent = testTitle;
                document.getElementById('welcome-q-count').textContent = totalQuestions;
                
                const totalMarks = questions.reduce((sum, q) => sum + (q.pos_marks ?? 1), 0);
                document.getElementById('welcome-marks').textContent = totalMarks;
                
                const firstQuestion = questions[0] || {};
                const posMarks = firstQuestion.pos_marks ?? 1;
                const negMarks = firstQuestion.neg_marks ?? 0;
                document.getElementById('welcome-marking').innerHTML = `<span style="color: var(--success);">+${posMarks}</span> <span style="color: var(--danger); margin-left:8px;">-${negMarks}</span>`;
                
                document.getElementById('welcome-time').textContent = `${testData.time}:00`;
                document.getElementById('timer-display').textContent = `${testData.time.toString().padStart(2, '0')}:00`;
                
                document.querySelectorAll('#total-count').forEach(el => { 
                    el.textContent = totalQuestions 
                });
                
                document.getElementById('start-area').innerHTML = `<button id="start-test-btn" class="btn btn-primary" onclick="showUserDetailsPopup()">Start Test</button>`;
                
            } catch(e) {
                console.error("Error loading test:", e);
                throw e; 
            }
        }

        /**
         * Test UI initialize karta hai
         */
        function initializeTest() {
            const paletteContainer = document.getElementById('question-palette');
            const tabsContainer = document.getElementById('section-tabs-container');
            paletteContainer.innerHTML = ''; 
            tabsContainer.innerHTML = '';
            
            let questionCounter = 0;
            
            sections.forEach((section, sectionIndex) => {
                // Section tab
                const tab = document.createElement('button');
                tab.className = 'section-tab';
                tab.textContent = section.name;
                tab.onclick = () => showQuestion(questions.findIndex(q => q.id === section.questions[0].id));
                tabsContainer.appendChild(tab);

                // Section title in palette
                const sectionTitle = document.createElement('div');
                sectionTitle.className = 'nav-section-title';
                sectionTitle.textContent = section.name;
                paletteContainer.appendChild(sectionTitle);

                // Question boxes
                const grid = document.createElement('div');
                grid.className = 'question-grid';
                
                section.questions.forEach((q) => {
                    const box = document.createElement('div');
                    box.className = 'q-box';
                    box.textContent = questionCounter + 1;
                    const qIndex = questionCounter;
                    box.onclick = () => showQuestion(qIndex);
                    box.id = `box-${qIndex}`;
                    grid.appendChild(box);
                    questionCounter++;
                });
                
                paletteContainer.appendChild(grid);
            });
            
            showQuestion(0);
        }

        /* ==================== TEST CORE LOGIC ==================== */
        
        /**
         * User details verify karke test start karta hai
         */
        function proceedToTest() {
            userName = document.getElementById('user-name-input').value.trim();
            userMobile = document.getElementById('user-mobile-input').value.trim();
            
            if (!userName) { 
                showToast('Please enter your name', 'error');
                return; 
            }
            if (!/^\d{10}$/.test(userMobile)) { 
                showToast('Please enter valid 10-digit mobile number', 'error');
                return; 
            }
            
            localStorage.setItem('userName', userName);
            localStorage.setItem('userMobile', userMobile);
            localStorage.removeItem('testProgress');
            
            document.body.style.overflow = '';
            document.getElementById('user-details-modal').classList.remove('show');
            
            testStarted = true;
            history.pushState({page: 'test'}, 'Test In Progress', '#test');
            showTestUI();
            startTimer();
            window.addEventListener('beforeunload', beforeUnloadHandler);
            
            showToast('Test started! All the best! üéØ', 'success', 2000);
            
            // Telegram notification
            sendToTelegramLog({ 
                type: 'Test Started', 
                userName: userName, 
                userMobile: userMobile 
            });
        }
        
        /**
         * Question timer start
         */
        function startQuestionTimer() { 
            if (submitted || !testStarted) return; 
            timeOnCurrentQuestion = 0; 
            questionTimer = setInterval(() => { 
                timeOnCurrentQuestion++; 
            }, 1000); 
        }
        
        /**
         * Question timer stop aur time save
         */
        function stopAndRecordTime() { 
            clearInterval(questionTimer); 
            if (questions.length > 0 && currentQuestion < questions.length) { 
                const qId = questions[currentQuestion].id; 
                timeSpent[qId] = (timeSpent[qId] || 0) + timeOnCurrentQuestion; 
            } 
        }
        
        /**
         * Question display karta hai
         */
        function showQuestion(index) {
            if (index < 0 || index >= questions.length) return;
            
            stopAndRecordTime();
            currentQuestion = index;
            const question = questions[index];
            
            document.getElementById('question-counter').textContent = `Question ${index + 1} of ${totalQuestions}`;
            
            // Current question highlight
            document.querySelectorAll('.q-box').forEach(box => box.classList.remove('current'));
            const currentBox = document.getElementById(`box-${index}`);
            if (currentBox && currentBox.style.display !== 'none') {
                currentBox.classList.add('current');
            }
            
            // Active section tab
            const currentSectionIndex = sections.findIndex(s => s.questions.some(q => q.id === question.id));
            document.querySelectorAll('.section-tab').forEach((tab, i) => {
                tab.classList.toggle('active', i === currentSectionIndex);
            });
            
            updateMarkForReviewUI();

            // Language toggle
            let langToggleHTML = `<div class="lang-toggle-container">
                <button class="lang-toggle-btn ${currentLang === 'en' ? 'active' : ''}" onclick="toggleLanguage('en')">English</button>
                <button class="lang-toggle-btn ${currentLang === 'hi' ? 'active' : ''}" onclick="toggleLanguage('hi')">‡§π‡§ø‡§Ç‡§¶‡•Ä</button>
            </div>`;
            
            // Image
            let imageHTML = question.image_url ? 
                `<div class="question-image-container"><img src="${question.image_url}" alt="Question Image" class="question-image"></div>` : '';
            
            // Question HTML
            let html = `<div class="question-card">
                ${langToggleHTML}
                <div class="question-text">
                    <div class="en">${question.question_en.replace(/\n/g, '<br>')}</div>
                    <div class="hi" style="display:none">${question.question_hi.replace(/\n/g, '<br>')}</div>
                </div>
                ${imageHTML}
                <div class="options" id="options-container">`;
            
            // Options
            const options = ['a', 'b', 'c', 'd'];
            (question.options_en || []).forEach((opt_label, i) => {
                let optionClass = ''; 
                let isUserAnswer = answers[question.id] === options[i];
                
                if (submitted) { 
                    if (options[i] === question.correct) 
                        optionClass += ' correct-answer'; 
                    else if (isUserAnswer) 
                        optionClass += ' incorrect'; 
                }
                
                html += `<div class="option-item">
                    <input class="option-input" type="radio" name="q${index}" id="opt-${index}-${options[i]}" 
                           value="${options[i]}" ${isUserAnswer ? 'checked' : ''} 
                           onclick="selectAnswer('${question.id}', '${options[i]}')">
                    <label class="option-label${optionClass}" for="opt-${index}-${options[i]}">
                        <div class="en">${question.options_en[i]}</div>
                        <div class="hi" style="display:none">${question.options_hi[i]}</div>
                    </label>
                </div>`;
            });
            html += `</div>`;
            
            // Solution (if submitted)
            if (submitted) {
                const resultText = answers[question.id] ? 
                    (answers[question.id] === question.correct ? 'Correct!' : 'Incorrect!') : 
                    'Not attempted';
                const time = timeSpent[question.id] || 0;
                const minutes = Math.floor(time / 60); 
                const seconds = time % 60;
                
                html += `<div class="solution-container">
                    <div class="solution-title">${resultText}</div>
                    <div class="solution-text">
                        <div class="en">${question.solution_en}</div>
                        <div class="hi" style="display:none">${question.solution_hi}</div>
                    </div>
                    <div class="time-taken-info">Time Taken: ${minutes}m ${seconds}s</div>
                </div>`;
            }
            html += `</div>`;
            
            document.getElementById('questions-container').innerHTML = html;
            
            applyLanguage();
            
            if (window.innerWidth < 992 && !submitted) toggleNav(false);
            
            if (submitted) document.getElementById('options-container').classList.add('review-mode');
            
            if (typeof MathJax !== 'undefined') MathJax.typeset();
            
            startQuestionTimer();
        }

        function applyLanguage() { 
            document.querySelectorAll('.en').forEach(el => 
                el.style.display = currentLang === 'en' ? 'block' : 'none'
            ); 
            document.querySelectorAll('.hi').forEach(el => 
                el.style.display = currentLang === 'hi' ? 'block' : 'none'
            ); 
        }
        
        /**
         * Answer select karta hai
         */
        function selectAnswer(qId, option) { 
            if (submitted) return; 
            
            answers[qId] = option; 
            updateProgress(); 
            
            document.getElementById(`box-${questions.findIndex(q => q.id === qId)}`).classList.add('attempted');
            
            showToast('Answer saved ‚úì', 'success', 1000);
        }
        
        function prevQuestion() { 
            if (currentQuestion > 0) showQuestion(currentQuestion - 1); 
        }
        
        function nextQuestion() { 
            if (currentQuestion < questions.length - 1) showQuestion(currentQuestion + 1); 
        }
        
        function toggleLanguage(lang) { 
            if (currentLang !== lang) { 
                currentLang = lang; 
                showQuestion(currentQuestion);
                showToast(`Language: ${lang === 'en' ? 'English' : '‡§π‡§ø‡§Ç‡§¶‡•Ä'}`, 'info', 1000);
            } 
        }
        
        function toggleNav(show) { 
            const nav = document.getElementById('question-nav'); 
            const overlay = document.getElementById('nav-overlay'); 
            
            if (show === undefined) show = !nav.classList.contains('show'); 
            
            nav.classList.toggle('show', show); 
            overlay.classList.toggle('show', show); 
            
            if (window.innerWidth < 992) 
                document.body.style.overflow = show ? 'hidden' : ''; 
        }
        
        function updateProgress() { 
            document.getElementById('attempted-count').textContent = Object.keys(answers).length; 
        }

        /**
         * Main timer with sound & vibration alerts
         */
        function startTimer() {
            let timeLeft = totalTime;
            const timerDisplay = document.getElementById('timer-display');
            const submitBtn = document.getElementById('submit-btn-header');

            timerDisplay.textContent = `${Math.floor(timeLeft / 60).toString().padStart(2, '0')}:${(timeLeft % 60).toString().padStart(2, '0')}`;

            timerInterval = setInterval(() => {
                if (timeLeft <= 0 || submitted) {
                    clearInterval(timerInterval);
                    if (submitBtn) submitBtn.classList.remove('blinking');
                    if (!submitted) submitTest();
                    return;
                }
                
                timeLeft--;

                // ===== 30 SECONDS WARNING =====
                if (timeLeft === 30 && !submitted) {
                    if (submitBtn) submitBtn.classList.add('blinking');
                    
                    // Sound alert
                    playAlertSound('warning');
                    
                    // Vibration
                    triggerVibration([200, 100, 200]);
                    
                    // Toast notification
                    showToast('‚è∞ Only 30 seconds remaining!', 'warning', 3000);
                }

                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
            
            setInterval(saveProgress, 5000); 
        }

        /* ==================== Mark for Review ==================== */
        
        function markQuestionForReview() {
            if (submitted) return;
            
            const qId = questions[currentQuestion].id;
            markedForReview[qId] = !markedForReview[qId];
            
            updateMarkForReviewUI();
            
            const action = markedForReview[qId] ? 'marked' : 'unmarked';
            showToast(`Question ${action} for review`, 'info', 1500);
        }
        
        function updateMarkForReviewUI() {
            if (submitted) return;
            
            const qId = questions[currentQuestion].id;
            const isMarked = markedForReview[qId];
            const box = document.getElementById(`box-${currentQuestion}`);
            
            const btn = document.getElementById('inline-mark-btn');
            if(btn) {
                const icon = btn.querySelector('i');
                if (isMarked) { 
                    btn.classList.add('marked'); 
                    icon.className = 'fas fa-flag';
                } else { 
                    btn.classList.remove('marked'); 
                    icon.className = 'far fa-flag';
                }
            }
            
            if (box) { 
                box.classList.toggle('marked', isMarked); 
            }
        }
        
        /* ==================== SUBMISSION & RESULTS ==================== */
        
        function confirmSubmit(){
            if(submitted) return;
            
            stopAndRecordTime();
            const attemptedCount = Object.keys(answers).length;
            
            const confirmModal = document.createElement("div");
            confirmModal.className = "results-modal show";
            confirmModal.innerHTML = `<div class="results-card" style="margin: auto;">
                <h4 class="mb-3">Confirm Submission</h4>
                <p class="text-secondary mb-4">You have attempted ${attemptedCount} of ${totalQuestions} questions.<br>Are you sure you want to submit?</p>
                <div class="d-flex justify-content-center gap-2">
                    <button onclick="startQuestionTimer(); this.closest('.results-modal').remove()" class="btn btn-outline-secondary">Cancel</button>
                    <button onclick="submitTest(); this.closest('.results-modal').remove()" class="btn btn-primary">Submit Test</button>
                </div>
            </div>`;
            
            document.body.appendChild(confirmModal);
        }
        
        /**
         * Test submit with confetti on good score
         */
        function submitTest() {
            document.getElementById('submit-btn-header')?.classList.remove('blinking');
            
            if (submitted) return; 
            
            localStorage.removeItem('testProgress');
            submitted = true; 
            clearInterval(timerInterval);
            stopAndRecordTime();
            window.removeEventListener('beforeunload', beforeUnloadHandler);
            
            // Results calculation
            let score = 0, correctCount = 0, incorrectCount = 0;
            topicAnalysis = {};

            questions.forEach((q, index) => {
                const box = document.getElementById(`box-${index}`);
                box.classList.remove('attempted', 'marked', 'current');
                
                const pos_marks = q.pos_marks ?? 1;
                const neg_marks = q.neg_marks ?? 0;
                const topic = q.topic || "General";
                
                if (!topicAnalysis[topic]) {
                    topicAnalysis[topic] = { correct: 0, incorrect: 0, total: 0 };
                }
                topicAnalysis[topic].total++;
                
                if (!answers[q.id]) { 
                    box.classList.add('unattempted'); 
                } else if (answers[q.id] === q.correct) { 
                    score += pos_marks; 
                    correctCount++; 
                    box.classList.add('correct');
                    topicAnalysis[topic].correct++;
                } else { 
                    score -= neg_marks; 
                    incorrectCount++; 
                    box.classList.add('incorrect'); 
                    topicAnalysis[topic].incorrect++;
                }
            });
            
            const unattemptedCount = totalQuestions - (correctCount + incorrectCount);
            
            // Test history save
            const history = JSON.parse(localStorage.getItem('testHistory') || '[]');
            history.push({ 
                testTitle, 
                score: score.toFixed(2), 
                date: new Date().toISOString() 
            });
            localStorage.setItem('testHistory', JSON.stringify(history));

            // Results UI update
            document.getElementById('score-value').textContent = score.toFixed(2);
            document.getElementById('correct-value').textContent = correctCount;
            document.getElementById('incorrect-value').textContent = incorrectCount;
            document.getElementById('unattempted-value').textContent = unattemptedCount;
            
            renderTopicAnalysisChart();
            
            document.getElementById('results-modal').classList.add('show');
            
            // Submit button disable
            const submitBtn = document.getElementById('submit-btn-header'); 
            if(submitBtn) { 
                submitBtn.disabled = true; 
                submitBtn.innerHTML = '<i class="fas fa-check"></i>'; 
                submitBtn.classList.add('submitted-state'); 
            }
            
            // ===== CONFETTI ANIMATION ON GOOD SCORE (>80%) =====
            const percentage = (correctCount / totalQuestions) * 100;
            if (percentage >= 80) {
                // Success sound
                playAlertSound('success');
                
                // Confetti burst
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
                
                // Multiple confetti bursts
                setTimeout(() => {
                    confetti({
                        particleCount: 50,
                        angle: 60,
                        spread: 55,
                        origin: { x: 0 }
                    });
                }, 250);
                
                setTimeout(() => {
                    confetti({
                        particleCount: 50,
                        angle: 120,
                        spread: 55,
                        origin: { x: 1 }
                    });
                }, 400);
                
                showToast('üéâ Excellent performance!', 'success', 3000);
            } else if (percentage >= 60) {
                showToast('üëç Good job!', 'success', 2000);
            } else {
                showToast('Keep practicing! üí™', 'info', 2000);
            }
            
            // Telegram notification
            sendToTelegramLog({ 
                type: 'Test Submitted', 
                userName: userName, 
                userMobile: userMobile, 
                score: score.toFixed(2), 
                correct: correctCount, 
                incorrect: incorrectCount, 
                unattempted: unattemptedCount 
            });
            
            showQuestion(currentQuestion);
        }

        /**
         * Topic analysis chart
         */
        function renderTopicAnalysisChart() {
            const ctx = document.getElementById('topicAnalysisChart').getContext('2d');
            const labels = Object.keys(topicAnalysis);
            
            const data = labels.map(label => {
                const { correct, total } = topicAnalysis[label];
                return total > 0 ? (correct / total) * 100 : 0;
            });

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Accuracy (%)',
                        data: data,
                        backgroundColor: 'rgba(0, 123, 255, 0.6)',
                        borderColor: 'rgba(0, 123, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            max: 100 
                        } 
                    },
                    plugins: { 
                        legend: { display: false }, 
                        title: { 
                            display: true, 
                            text: 'Topic-wise Performance' 
                        } 
                    }
                }
            });
        }

        function reviewTest(){
            document.getElementById("results-modal").classList.remove("show");
            document.getElementById("floating-pdf-btn").style.display="flex";
            showQuestion(0);
            showToast('Review mode activated', 'info', 2000);
        }
        
        window.addEventListener('click', e => { 
            if (e.target.classList.contains('results-modal')) 
                e.target.classList.remove('show'); 
        });

        /* ==================== PROGRESS SAVING & LOADING ==================== */
        
        function saveProgress() {
            if (!testStarted || submitted) return;
            
            let timeLeft = 0;
            const timerDisplay = document.getElementById('timer-display').textContent;
            if (timerDisplay) {
                const parts = timerDisplay.split(':');
                if (parts.length === 2) { 
                    timeLeft = parseInt(parts[0], 10) * 60 + parseInt(parts[1], 10); 
                }
            }
            
            const progress = {
                userName, 
                userMobile, 
                answers, 
                timeLeft, 
                currentQuestion, 
                markedForReview, 
                timeSpent,
                testId: new URLSearchParams(window.location.search).get('test')
            };
            
            localStorage.setItem('testProgress', JSON.stringify(progress));
        }

        function loadProgress() {
            const savedProgress = localStorage.getItem('testProgress');
            
            if (savedProgress) {
                const progress = JSON.parse(savedProgress);
                const currentTestId = new URLSearchParams(window.location.search).get('test');
                
                if (progress.testId === currentTestId) {
                    if (confirm("Welcome back! It looks like you have an unfinished test. Do you want to resume?")) {
                        userName = progress.userName || localStorage.getItem('userName') || '';
                        userMobile = progress.userMobile || localStorage.getItem('userMobile') || '';
                        answers = progress.answers || {};
                        markedForReview = progress.markedForReview || {};
                        timeSpent = progress.timeSpent || {};
                        totalTime = progress.timeLeft || totalTime; 
                        
                        testStarted = true;
                        history.pushState({page: 'test'}, 'Test In Progress', '#test');
                        showTestUI();
                        startTimer();
                        window.addEventListener('beforeunload', beforeUnloadHandler);
                        
                        updateProgress();
                        
                        Object.keys(answers).forEach(qId => {
                            const qIndex = questions.findIndex(q => q.id === qId);
                            if (qIndex !== -1) 
                                document.getElementById(`box-${qIndex}`).classList.add('attempted');
                        });
                        
                        Object.keys(markedForReview).forEach(qId => {
                             const qIndex = questions.findIndex(q => q.id === qId);
                             if (qIndex !== -1 && markedForReview[qId]) 
                                 document.getElementById(`box-${qIndex}`).classList.add('marked');
                        });

                        showQuestion(progress.currentQuestion || 0);
                        
                        showToast('Test resumed successfully', 'success', 2000);
                        
                        return true; 
                    } else {
                        localStorage.removeItem('testProgress');
                    }
                } else {
                    localStorage.removeItem('testProgress');
                }
            }
            return false;
        }

        /* ==================== TELEGRAM WITH RETRY MECHANISM ==================== */
        
        /**
         * Telegram pe message bhejta hai with retry mechanism
         * Agar fail ho to localStorage me save karta hai
         * 
         * @param {Object} eventData - Event details
         * @param {number} retries - Maximum retry attempts
         */
        async function sendToTelegramLog(eventData, retries = 3) {
            const BOT_TOKEN = decodeToken(BOT_TOKEN_ENCODED);
            
            if (!BOT_TOKEN || !CHAT_ID) {
                console.warn("Telegram API credentials are not set.");
                return;
            }
            
            const apiURL = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
            let messageText = "";
            const testName = testTitle;
            const timestamp = new Date().toLocaleString("en-IN", { timeZone: "Asia/Kolkata" });
            
            // Message format
            if (eventData.type === "Test Started") {
                messageText = `üî¥ *New Test Started!*\n\n` +
                    `- *User:* \`${eventData.userName || "N/A"}\`\n` +
                    `- *Mobile:* \`${eventData.userMobile || "N/A"}\`\n` +
                    `- *Test:* \`${testName}\`\n` +
                    `- *Time:* \`${timestamp}\``;
            } else if (eventData.type === "Test Submitted") {
                messageText = `‚úÖ *Test Submitted!*\n\n` +
                    `- *User:* \`${eventData.userName || "N/A"}\`\n` +
                    `- *Mobile:* \`${eventData.userMobile || "N/A"}\`\n` +
                    `- *Test:* \`${testName}\`\n` +
                    `- *Score:* *${eventData.score}*\n` +
                    `- *Correct:* ${eventData.correct}\n` +
                    `- *Incorrect:* ${eventData.incorrect}\n` +
                    `- *Unattempted:* ${eventData.unattempted}\n` +
                    `- *Time:* \`${timestamp}\``;
            }
            
            // ===== RETRY MECHANISM WITH EXPONENTIAL BACKOFF =====
            for (let attempt = 1; attempt <= retries; attempt++) {
                try {
                    const response = await fetch(apiURL, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            chat_id: CHAT_ID,
                            text: messageText,
                            parse_mode: "Markdown",
                            message_thread_id: TOPIC_ID
                        })
                    });
                    
                    if (response.ok) {
                        console.log('Telegram notification sent successfully');
                        return; // Success - exit function
                    } else {
                        console.warn(`Attempt ${attempt} failed with status: ${response.status}`);
                    }
                    
                } catch (error) {
                    console.warn(`Telegram attempt ${attempt} failed:`, error.message);
                    
                    // Last attempt failed - save to localStorage
                    if (attempt === retries) {
                        const failedLogs = JSON.parse(localStorage.getItem('failedTelegramLogs') || '[]');
                        failedLogs.push({
                            eventData, 
                            messageText,
                            timestamp: Date.now()
                        });
                        localStorage.setItem('failedTelegramLogs', JSON.stringify(failedLogs));
                        
                        console.error('All Telegram attempts failed. Saved to localStorage.');
                    } else {
                        // Exponential backoff: wait before next retry
                        const waitTime = 1000 * Math.pow(2, attempt - 1); // 1s, 2s, 4s...
                        await new Promise(resolve => setTimeout(resolve, waitTime));
                    }
                }
            }
        }

        /* ==================== PDF DOWNLOAD ==================== */

        async function downloadPDF(buttonElement) {
            const btn = buttonElement;
            const originalHTML = btn.innerHTML;
            btn.disabled = true;

            const overlay = document.createElement('div');
            overlay.className = 'pdf-generating-overlay';
            overlay.innerHTML = `<div class="spinner-border" role="status"></div>
                <p>Generating PDF...</p>
                <p id="pdf-progress-text" style="font-size: 0.9em;"></p>`;
            document.body.appendChild(overlay);
            const progressText = document.getElementById('pdf-progress-text');

            try {
                const { jsPDF: jsPDF_lib } = window.jspdf;
                const doc = new jsPDF_lib({
                    unit: "pt",
                    format: "a4",
                    orientation: "portrait"
                });
                const fileName = `${testTitle} Result by Kundan.pdf`;
                const isAndroidApp = window.Android && typeof window.Android.startPdf === 'function';

                const saveInApp = (pdfDoc) => {
                    progressText.textContent = "Saving to device...";
                    setTimeout(() => {
                        const pdfDataString = pdfDoc.output('datauristring');
                        
                        if (currentLang !== 'hi' && pdfDataString.length < 2000000) {
                            window.Android.saveBase64String(pdfDataString, fileName);
                            return;
                        }

                        const pureBase64 = pdfDataString.split(',')[1];
                        const downloadId = `pdf_${Date.now()}`;
                        window.Android.startPdf(downloadId, fileName);
                        const chunkSize = 16384;
                        for (let i = 0; i < pureBase64.length; i += chunkSize) {
                            const chunk = pureBase64.substring(i, i + chunkSize);
                            window.Android.appendPdfChunk(downloadId, chunk);
                        }
                        window.Android.finishPdf(downloadId);
                    }, 50);
                };

                if (currentLang === 'hi') {
                    progressText.textContent = "Initializing Hindi PDF...";
                    const pdfWidth = doc.internal.pageSize.getWidth();
                    const margin = 40;
                    let yPosition = margin;
                    
                    const headerContainer = document.createElement('div');
                    headerContainer.style.width = '700px'; 
                    headerContainer.style.padding = '20px'; 
                    headerContainer.style.background = '#fff'; 
                    headerContainer.style.color = '#000';
                    
                    let headerHTML = `<div style="text-align:center;">
                        <h1>Test Analysis: ${testTitle}</h1>
                        <p><strong>Developer: Kundan Yadav</strong></p>
                        <hr>
                        <p><strong>User:</strong> ${userName || "N/A"} | <strong>Mobile:</strong> ${userMobile || "N/A"}</p>
                    </div>
                    <hr>
                    <div style="display:flex; justify-content:space-around; text-align:center; margin:20px 0;">
                        <div><h3>${document.getElementById("score-value").textContent}</h3><p>Score</p></div>
                        <div><h3>${document.getElementById("correct-value").textContent}</h3><p>Correct</p></div>
                        <div><h3>${document.getElementById("incorrect-value").textContent}</h3><p>Incorrect</p></div>
                        <div><h3>${document.getElementById("unattempted-value").textContent}</h3><p>Unattempted</p></div>
                    </div>
                    <div style="text-align:center; margin:20px 0;">
                        <img src="${document.getElementById("topicAnalysisChart").toDataURL("image/png", 1.0)}" 
                             style="width:100%; max-width:500px;" />
                    </div>`;
                    
                    headerContainer.innerHTML = headerHTML;
                    document.body.appendChild(headerContainer);
                    
                    const headerCanvas = await html2canvas(headerContainer, { scale: 1.5 });
                    const headerImgData = headerCanvas.toDataURL('image/png');
                    const headerImgHeight = (headerCanvas.height * (pdfWidth - 2 * margin)) / headerCanvas.width;
                    doc.addImage(headerImgData, 'PNG', margin, yPosition, pdfWidth - 2 * margin, headerImgHeight);
                    yPosition += headerImgHeight + 20;
                    document.body.removeChild(headerContainer);

                    await new Promise(resolve => setTimeout(resolve, 10));
                    
                    for (let i = 0; i < questions.length; i++) {
                        progressText.textContent = `Processing question ${i + 1} of ${questions.length}...`;
                        
                        const q = questions[i];
                        const questionContainer = document.createElement('div');
                        questionContainer.style.width = '700px';
                        questionContainer.style.padding = '20px';
                        questionContainer.style.background = '#fff';
                        questionContainer.style.color = '#000';
                        
                        const questionText = q.question_hi || q.question_en;
                        const solutionText = q.solution_hi || q.solution_en;
                        const optionsArray = q.options_hi || q.options_en;
                        
                        let optionsHTML = '';
                        const userAnswer = answers[q.id];
                        const correctAnswer = q.correct;
                        const optionKeys = ['a', 'b', 'c', 'd'];
                        
                        optionsArray.forEach((opt, idx) => {
                            const optionKey = optionKeys[idx];
                            let style = 'margin:5px 0; font-family: sans-serif;';
                            let prefix = `${String.fromCharCode(65 + idx)}) `;
                            
                            if (optionKey === correctAnswer) {
                                style += ' color: green; font-weight: bold;';
                                if (userAnswer === optionKey) {
                                    prefix = `‚úì ${prefix}`;
                                }
                            } else if (optionKey === userAnswer) {
                                style += ' color: red;';
                                prefix = `‚úó ${prefix}`;
                            }
                            
                            optionsHTML += `<p style="${style}">${prefix}${opt}</p>`;
                        });
                        
                        const status = answers[q.id] ? 
                            (answers[q.id] === q.correct ? "Correct" : "Incorrect") : 
                            "Unattempted";
                        const time = timeSpent[q.id] || 0;
                        const minutes = Math.floor(time / 60);
                        const seconds = time % 60;
                        const timeTakenText = `${minutes}m ${seconds}s`;
                        
                        questionContainer.innerHTML = `<hr>
                            <div style="font-family: sans-serif; overflow: hidden;">
                                <h4>Q${i + 1}: ${questionText}</h4>
                                ${optionsHTML}
                                <p><strong>Status:</strong> ${status} 
                                   <span style="float: right; color: #555; font-size: 0.9em;">Time Taken: ${timeTakenText}</span>
                                </p>
                                <div style="background:#f0f8ff; padding:10px; border-radius:5px; margin-top: 10px;">
                                    <strong>Solution:</strong> ${solutionText}
                                </div>
                            </div>`;
                        
                        document.body.appendChild(questionContainer);
                        
                        const qCanvas = await html2canvas(questionContainer, { scale: 1.5 });
                        const qImgData = qCanvas.toDataURL('image/png');
                        const qImgHeight = (qCanvas.height * (pdfWidth - 2 * margin)) / qCanvas.width;
                        
                        if (yPosition + qImgHeight > doc.internal.pageSize.getHeight() - margin) {
                            doc.addPage();
                            yPosition = margin;
                        }
                        
                        doc.addImage(qImgData, 'PNG', margin, yPosition, pdfWidth - 2 * margin, qImgHeight);
                        yPosition += qImgHeight;
                        document.body.removeChild(questionContainer);
                        
                        await new Promise(resolve => setTimeout(resolve, 10));
                    }
                    
                    if (isAndroidApp) { 
                        saveInApp(doc); 
                    } else { 
                        doc.save(fileName); 
                    }
                    
                } else {
                    progressText.textContent = "Processing English PDF...";
                    
                    let yPos = 40;
                    const marginX = 40;
                    const pageWidth = doc.internal.pageSize.width - 2 * marginX;
                    
                    const addNewPage = () => {
                        doc.addPage();
                        yPos = marginX;
                    };
                    
                    doc.setFont("Helvetica", "bold");
                    doc.setFontSize(18);
                    doc.text(`Test Analysis: ${testTitle}`, doc.internal.pageSize.width / 2, yPos, { align: "center" });
                    
                    yPos += 25;
                    doc.setFont("Helvetica", "bold");
                    doc.setFontSize(12);
                    doc.setTextColor(0, 84, 166);
                    const devText = "Developer: Kundan Yadav";
                    doc.textWithLink(devText, doc.internal.pageSize.width / 2, yPos, {
                        url: "https://t.me/kundan_yadav_bot",
                        align: "center"
                    });
                    
                    doc.setFont("Helvetica", "normal");
                    doc.setTextColor(0, 0, 0);
                    yPos += 25;
                    doc.setFontSize(12);
                    doc.text(`User: ${userName || "N/A"}`, marginX, yPos);
                    yPos += 15;
                    doc.text(`Mobile: ${userMobile || "N/A"}`, marginX, yPos);
                    
                    yPos += 20;
                    doc.setLineWidth(1.5);
                    doc.line(marginX, yPos, doc.internal.pageSize.width - marginX, yPos);
                    
                    yPos += 30;
                    doc.setFontSize(10);
                    const cardWidth = (pageWidth - 30) / 4;
                    const cardHeight = 50;
                    
                    const statsData = [
                        { label: "Score", value: document.getElementById("score-value").textContent, color: [0, 123, 255] },
                        { label: "Correct", value: document.getElementById("correct-value").textContent, color: [40, 167, 69] },
                        { label: "Incorrect", value: document.getElementById("incorrect-value").textContent, color: [220, 53, 69] },
                        { label: "Unattempted", value: document.getElementById("unattempted-value").textContent, color: [108, 117, 125] }
                    ];
                    
                    statsData.forEach((item, index) => {
                        doc.setFillColor(item.color[0], item.color[1], item.color[2]);
                        doc.roundedRect(marginX + index * (cardWidth + 10), yPos, cardWidth, cardHeight, 5, 5, "F");
                        
                        doc.setTextColor(255, 255, 255);
                        doc.setFont("Helvetica", "bold");
                        doc.setFontSize(16);
                        doc.text(item.value, marginX + index * (cardWidth + 10) + cardWidth / 2, yPos + 25, { align: "center" });
                        
                        doc.setFont("Helvetica", "normal");
                        doc.setFontSize(10);
                        doc.text(item.label, marginX + index * (cardWidth + 10) + cardWidth / 2, yPos + 40, { align: "center" });
                    });
                    
                    yPos += cardHeight + 30;
                    const chartCanvas = document.getElementById("topicAnalysisChart");
                    const chartImage = chartCanvas.toDataURL("image/png", 1.0);
                    doc.addImage(chartImage, "PNG", marginX, yPos, pageWidth, pageWidth / 2);
                    yPos += pageWidth / 2 + 30;
                    
                    doc.setTextColor(0, 0, 0);
                    
                    questions.forEach((q, qIndex) => {
                        if (yPos > doc.internal.pageSize.height - 150) addNewPage();
                        
                        doc.setLineWidth(0.5);
                        doc.line(marginX, yPos, doc.internal.pageSize.width - marginX, yPos);
                        yPos += 20;
                        
                        const questionText = q.question_en || "";
                        doc.setFont("Helvetica", "bold");
                        doc.setFontSize(11);
                        const wrappedQuestion = doc.splitTextToSize(`Q${qIndex + 1}: ${questionText.replace(/\n/g, " ")}`, pageWidth);
                        doc.text(wrappedQuestion, marginX, yPos);
                        yPos += 12 * wrappedQuestion.length + 10;
                        
                        doc.setFont("Helvetica", "normal");
                        doc.setFontSize(10);
                        const optionKeys = ["a", "b", "c", "d"];
                        const optionsArray = q.options_en || [];
                        
                        optionsArray.forEach((optText, optIndex) => {
                            const userAnswer = answers[q.id];
                            const correctAnswer = q.correct;
                            const currentOptionKey = optionKeys[optIndex];
                            
                            let optionText = `${String.fromCharCode(65 + optIndex)}) ${optText}`;
                            
                            if (currentOptionKey === correctAnswer) {
                                doc.setTextColor(40, 167, 69);
                                optionText = (userAnswer === currentOptionKey ? "‚úì " : "  ") + optionText;
                            } else if (currentOptionKey === userAnswer) {
                                doc.setTextColor(220, 53, 69);
                                optionText = `‚úó ${optionText}`;
                            } else {
                                doc.setTextColor(50, 50, 50);
                                optionText = `  ${optionText}`;
                            }
                            
                            doc.text(optionText, marginX + 15, yPos);
                            yPos += 15;
                        });
                        
                        doc.setTextColor(0, 0, 0);
                        
                        const timeValue = timeSpent[q.id] || 0;
                        const mins = Math.floor(timeValue / 60);
                        const secs = timeValue % 60;
                        
                        let statusText = answers[q.id] ?
                            (answers[q.id] === q.correct ? "Correct" : "Incorrect") :
                            "Unattempted";
                        
                        let statusColor = answers[q.id] ?
                            (answers[q.id] === q.correct ? [40, 167, 69] : [220, 53, 69]) :
                            [108, 117, 125];
                        
                        doc.setFont("Helvetica", "bold");
                        doc.setTextColor(statusColor[0], statusColor[1], statusColor[2]);
                        doc.text(`Status: ${statusText}`, marginX, yPos);
                        
                        doc.setFont("Helvetica", "normal");
                        doc.setFontSize(9);
                        doc.setTextColor(108, 117, 125);
                        doc.text(`Time Taken: ${mins}m ${secs}s`, doc.internal.pageSize.width - marginX, yPos, { align: "right" });
                        
                        yPos += 20;
                        
                        doc.setFillColor(240, 248, 255);
                        const solutionText = q.solution_en || "";
                        const wrappedSolution = doc.splitTextToSize(`Solution: ${solutionText}`, pageWidth - 20);
                        doc.roundedRect(marginX, yPos - 10, pageWidth, 12 * wrappedSolution.length + 15, 3, 3, "F");
                        
                        doc.setTextColor(50, 50, 50);
                        doc.text(wrappedSolution, marginX + 10, yPos);
                        yPos += 12 * wrappedSolution.length + 15;
                    });
                    
                    if (isAndroidApp) { 
                        saveInApp(doc); 
                    } else { 
                        doc.save(fileName); 
                    }
                }
                
                showToast('PDF downloaded successfully! üìÑ', 'success', 2000);
                
            } catch (error) {
                console.error("Error generating PDF:", error);
                showToast('PDF generation failed', 'error', 2000);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
                if (overlay) {
                    document.body.removeChild(overlay);
                }
            }
        }
    </script>
</body>
</html>