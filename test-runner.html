<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading Test...</title>
    
    <!-- ==================== External Libraries ==================== -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        /* ==================== Root Variables & Dark Mode ==================== */
        /* Theme colors aur variables define kiye gaye hain */
        :root{--primary:#007bff;--primary-light:#52a4ff;--primary-dark:#0056b3;--secondary:#6c757d;--accent:#ffc107;--success:#28a745;--danger:#dc3545;--light:#f8f9fa;--dark:#343a40;--gray:#6c757d;--light-gray:#dfe6e9;--card-bg:#fff;--body-bg:#f4f7fe;--header-bg:linear-gradient(135deg,var(--primary),var(--primary-dark));--footer-bg:#fff;--box-shadow:0 4px 20px rgba(0,0,0,.08);--transition:all .3s cubic-bezier(.25,.8,.25,1)}
        
        /* Dark mode ke liye colors override */
        body.dark-mode{--primary:#3498db; --light:#2c3e50;--dark:#ecf0f1;--gray:#95a5a6;--light-gray:#34495e;--card-bg:#1e272e;--body-bg:#141d26;--footer-bg:#1e272e;--box-shadow:0 4px 20px rgba(0,0,0,.3);--accent:#f1c40f}
        body.dark-mode .header {background: linear-gradient(135deg, var(--primary), #2980b9);}
        body.dark-mode .nav-btn {border-color: var(--primary);color: var(--primary);}
        body.dark-mode .option-input:checked+.option-label{background:rgba(0,123,255,.15)}
        body.dark-mode .solution-container, body.dark-mode .topic-analysis-container{background:rgba(0,123,255,.1)}
        body.dark-mode .review-mode .option-label.correct-answer{background:rgba(40,167,69,.1)}
        body.dark-mode .review-mode .option-input:checked+.option-label.incorrect{background:rgba(220,53,69,.1)}
        body.dark-mode .results-card{background:var(--card-bg)}
        body.dark-mode #user-details-modal .user-details-card .form-control{background-color:#34495e;color:#ecf0f1;border-color:#566573}
        body.dark-mode #user-details-modal .user-details-card .form-control::placeholder{color:#95a5a6}
        
        /* ==================== Global & Body Styles ==================== */
        /* Basic styling for body and elements */
        *{-webkit-tap-highlight-color:transparent}
        body{background-color:var(--body-bg);font-family:Poppins,'Noto Sans Devanagari',sans-serif;color:var(--dark);line-height:1.6;overflow-x:hidden;transition:background-color .3s,color .3s}
        body:not(.welcome-mode){padding-top:60px;padding-bottom:80px}

        /* ==================== Welcome Screen ==================== */
        /* Welcome screen jab user test load karta hai */
        #welcome-screen{position:fixed;top:0;left:0;width:100%;height:100%;z-index:1200;display:flex;align-items:center;justify-content:center;padding:16px;overflow:hidden;background-size:cover;background-position:center center}
        #welcome-screen::before{content:'';position:absolute;top:-10px;left:-10px;right:-10px;bottom:-10px;z-index:-1;background:linear-gradient(rgba(29,36,47,.7),rgba(29,36,47,.7));backdrop-filter:blur(3px);-webkit-backdrop-filter:blur(3px)}
        .welcome-card{background:rgba(255,255,255,.1);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(15px);border:1px solid rgba(255,255,255,.2);border-radius:20px;padding:32px;width:100%;max-width:500px;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,.2);animation:fadeInUp .8s cubic-bezier(.25,.8,.25,1) forwards}
        @keyframes fadeInUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
        .welcome-icon{font-size:3rem;color:#fff;margin-bottom:16px;text-shadow:0 2px 10px rgba(0,0,0,.2)}
        .welcome-card h3{font-weight:700;font-size:1.8rem;color:#fff;margin-bottom:8px;text-shadow:0 1px 5px rgba(0,0,0,.2)}
        .welcome-branding a{color:rgba(255,255,255,.8);font-size:1.1rem;font-weight:500;text-decoration:none;margin-bottom:32px;display:inline-block;transition:var(--transition)}
        .welcome-branding a:hover{color:#fff}
        .welcome-branding .kundan-font{font-weight:600;color:#ff0}
        .welcome-stats{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-bottom:32px}
        .stat-item{background:rgba(255,255,255,.1);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,.2)}
        .stat-item .icon{font-size:1.5rem;color:#fff;margin-bottom:8px}
        .stat-item .value{font-size:1.4rem;font-weight:600;color:#fff}
        .stat-item .label{font-size:.85rem;color:rgba(255,255,255,.7);font-weight:500}
        #start-test-btn{width:100%;padding:14px;font-size:1.1rem;font-weight:600;border-radius:12px;animation:pulse 2s infinite}
        @keyframes pulse{0%{transform:scale(1);box-shadow:0 0 0 0 rgba(0,123,255,.4)}70%{transform:scale(1.02);box-shadow:0 0 0 10px rgba(0,123,255,0)}100%{transform:scale(1);box-shadow:0 0 0 0 rgba(0,123,255,0)}}
        
        /* ==================== Main Test UI: Header & Footer ==================== */
        /* Header - Top navigation bar */
        .header{position:fixed;top:0;left:0;right:0;height:60px;background:var(--header-bg);color:#fff;display:flex;align-items:center;padding:0 16px;z-index:1000;box-shadow:0 2px 10px rgba(0,0,0,.1)}
        .header-content{display:flex;justify-content:space-between;align-items:center;width:100%;gap:8px}
        .header-brand{display:flex;align-items:center;font-weight:600;color:#fff;text-decoration:none;flex:1 1 0;min-width:0}
        .header-brand i{margin-right:8px;font-size:1.2rem;flex-shrink:0}
        .header-brand span { white-space: normal; line-height: 1.2; font-size: 0.85rem; }
        .header-controls{display:flex;align-items:center;gap:8px;flex-shrink:0}
        .control-btn{width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,.1);border:none;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:var(--transition);flex-shrink:0}
        .control-btn:hover{background:rgba(255,255,255,.2)}
        
        /* Submit button styling */
        .submit-btn-header{height:34px;padding:0 10px;font-size:0.8rem;border-radius:17px}
        .submit-btn-header.submitted-state{padding:0;width:34px;background-color:var(--success);border-color:var(--success);cursor:default}
        
        /* Timer warning animation - 30 seconds bache to blink kare */
        @keyframes blink-animation {
            0% { background-color: var(--danger); transform: scale(1); box-shadow: 0 0 5px var(--danger); }
            50% { background-color: #ff7675; transform: scale(1.05); box-shadow: 0 0 15px #ff7675; }
            100% { background-color: var(--danger); transform: scale(1); box-shadow: 0 0 5px var(--danger); }
        }
        .submit-btn-header.blinking {
            animation: blink-animation 1.5s infinite;
            border-color: #fff;
            color: #fff;
        }
        .submit-btn-header:hover:not(.submitted-state){background:rgba(255,255,255,.25)}
        
        /* Timer display */
        .timer-display{background:rgba(0,0,0,.2);border-radius:18px;padding:4px 10px;font-size:.8rem;font-weight:500;display:flex;align-items:center;flex-shrink:0}
        .timer-display i{margin-right:6px}
        
        /* Bottom Navigation - Mobile view ke liye */
        .bottom-nav{position:fixed;bottom:0;left:0;right:0;height:80px;background:var(--footer-bg);box-shadow:0 -2px 10px rgba(0,0,0,.1);display:flex;align-items:center;justify-content:space-between;padding:0 16px;z-index:800;transition:background-color .3s}
        .nav-btn{height:48px;border-radius:12px;border:1px solid var(--primary);font-weight:500;display:flex;align-items:center;justify-content:center;padding:0 20px;transition:var(--transition);gap:8px;background:0 0;color:var(--primary);flex-shrink:0}
        
        /* Mark for review button */
        #inline-mark-btn { height: 40px; padding: 0 8px; font-size: 0.8rem; flex-grow: 1; margin: 0 8px; border-color: var(--secondary); color: var(--secondary); max-width: 100px; }
        #inline-mark-btn.marked { border-color: var(--accent); color: var(--accent); font-weight: 600; }
        
        /* Desktop Footer */
        .desktop-footer{position:fixed;bottom:0;left:0;right:320px;height:40px;background:var(--dark);color:#fff;align-items:center;justify-content:center;z-index:850;display:none}
        .desktop-footer.show{display:flex}
        .desktop-footer a{color:#fff;text-decoration:none;font-weight:500}
        .desktop-footer a:hover{color:var(--accent)}
        
        /* ==================== Section Tabs ==================== */
        /* Different sections ke tabs (e.g., Physics, Chemistry) */
        #section-tabs-container { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 8px; }
        .section-tab { padding: 8px 16px; border-radius: 50px; background: var(--light-gray); color: var(--secondary); font-weight: 500; cursor: pointer; transition: all 0.3s; white-space: nowrap; border: none; }
        
        /* Active tab styling - Light mode */
        .section-tab.active {
            background: #e67919; /* Bright Orange */
            color: #fff;
            box-shadow: 0 2px 8px rgba(230, 126, 34, 0.4);
        }
        /* Active tab styling - Dark mode */
        body.dark-mode .section-tab.active {
            background: #803300; /* Deeper Orange */
            color: #f0f0f0;
            box-shadow: 0 2px 8px rgba(211, 84, 0, 0.2);
        }
                        
        /* ==================== Main Test UI: Question & Options ==================== */
        .main-content{padding:16px;padding-bottom: 20px;}
        .question-card,.results-card,.question-nav{background:var(--card-bg);transition:background-color .3s}
        .question-card{border-radius:16px;padding:20px;margin-bottom:16px;box-shadow:0 2px 10px rgba(0,0,0,.05);border:1px solid transparent;overflow:hidden}
        .question-counter{font-size:.9rem;color:var(--gray);text-align:center;margin-bottom:16px;font-weight:500}
        .question-text{font-size:1.1rem;line-height:1.6;margin-bottom:20px;color:var(--dark);overflow-wrap:break-word;word-wrap:break-word}
        
        /* Question image styling */
        .question-image-container { text-align: center; margin-bottom: 20px; }
        .question-image { max-width: 100%; max-height: 250px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,.1); }
        
        /* Language toggle buttons (English/Hindi) */
        .lang-toggle-container{display:flex;justify-content:center;margin-bottom:20px;background-color:var(--light-gray);border-radius:12px;padding:4px}
        .lang-toggle-btn{flex:1;text-align:center;padding:8px 12px;border:none;background:0 0;cursor:pointer;border-radius:10px;font-weight:500;color:var(--secondary);transition:all .3s ease}
        .lang-toggle-btn.active{background-color:var(--card-bg);color:var(--primary);box-shadow:0 2px 5px rgba(0,0,0,.1)}
        body.dark-mode .lang-toggle-btn.active{background-color:#000;color:#fff;box-shadow:0 2px 5px rgba(0,0,0,.3)}
        
        /* Options styling */
        .option-item{margin-bottom:12px;position:relative}
        .option-input{position:absolute;opacity:0;width:0;height:0}
        .option-label{display:block;padding:14px 16px;background:var(--card-bg);border:1px solid var(--light-gray);border-radius:12px;cursor:pointer;transition:var(--transition);position:relative;overflow:hidden}
        .option-label:hover{border-color:var(--primary-light);transform:translateY(-2px);box-shadow:0 2px 10px rgba(0,0,0,.05)}
        .option-input:checked+.option-label{border-color:var(--primary);box-shadow:0 0 0 1px var(--primary)}
        .option-input:checked+.option-label::after{content:'';position:absolute;top:0;left:0;width:3px;height:100%;background:var(--primary)}
        
        /* Review mode colors - Correct/Incorrect answer indication */
        .review-mode .option-label.correct-answer{border-color:var(--success);background:rgba(40,167,69,.05)}
        .review-mode .option-label.correct-answer::after{background:var(--success)}
        .review-mode .option-input:checked+.option-label.incorrect{border-color:var(--danger);background:rgba(220,53,69,.05)}
        .review-mode .option-input:checked+.option-label.incorrect::after{background:var(--danger)}
        
        /* Solution container */
        .solution-container, .topic-analysis-container{margin-top:20px;padding:16px;border-radius:12px;border-left:3px solid var(--primary)}
        .solution-title{font-weight:600;margin-bottom:8px;color:var(--primary)}
        .time-taken-info{font-size:.8rem;color:var(--secondary);font-style:italic;margin-top:10px}
        
        /* ==================== Question Navigator (Sidebar) ==================== */
        /* Right sidebar with question palette */
        .question-nav{position:fixed;top:60px;right:0;bottom:0;width:100%;max-width:320px;box-shadow:-5px 0 15px rgba(0,0,0,.1);transform:translateX(100%);transition:var(--transition);z-index:900;overflow-y:auto;padding:16px}
        .question-nav.show{transform:translateX(0)}
        .nav-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .nav-title{font-weight:600;font-size:1.1rem;margin:0}
        .nav-section-title { font-weight: 600; color: var(--primary); margin-top: 16px; margin-bottom: 8px; font-size: 0.9rem; }
        
        /* Question boxes grid */
        .question-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(40px,1fr));gap:8px}
        .q-box{width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:10px;cursor:pointer;font-weight:500;border:1px solid var(--light-gray);background:var(--card-bg);transition:var(--transition)}
        .q-box.attempted{background-color:var(--primary);color:#fff;border-color:var(--primary)}
        .q-box.correct{background-color:var(--success);color:#fff;border-color:var(--success)}
        .q-box.incorrect{background-color:var(--danger);color:#fff;border-color:var(--danger)}
        .q-box.current{transform:scale(1.1); box-shadow: 0 0 10px var(--accent);}
        .q-box.unattempted{background-color:var(--gray);color:#fff;border-color:var(--gray)}
        .q-box.marked { background-color: var(--accent); color: var(--dark); border-color: var(--accent); font-weight: 600; }
        .q-box.attempted.marked { background-color: var(--primary); border: 2px solid var(--accent); }

        /* Overlay for mobile nav */
        .nav-overlay{position:fixed;top:60px;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:890;opacity:0;pointer-events:none;transition:var(--transition)}
        .nav-overlay.show{opacity:1;pointer-events:all}
        
        /* ==================== Modals & Other Components ==================== */
        /* Results modal - Test complete hone ke baad */
        .results-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:1100;opacity:0;pointer-events:none;transition:var(--transition);padding:16px; overflow-y: auto;}
        .results-modal.show{opacity:1;pointer-events:all}
        .results-card{border-radius:20px;width:100%;max-width:500px;padding:20px;text-align:center; margin: auto;}
        .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;margin-top:1rem;margin-bottom:1.5rem}
        .stat-card{color:#fff;padding:1rem;border-radius:12px}
        .stat-value{font-size:2rem;font-weight:600}
        .stat-label{font-size:.9rem}
        .results-footer{display:flex;justify-content:center;gap:16px}
        
        /* User details modal - Name aur mobile number input */
        #user-details-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:1250;display:flex;align-items:center;justify-content:center;padding:16px;opacity:0;pointer-events:none;transition:opacity .3s ease-in-out}
        #user-details-modal.show{opacity:1;pointer-events:all}
        .user-details-card{background:var(--card-bg);border-radius:20px;padding:32px;width:100%;max-width:450px;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,.3);transform:translateY(20px);opacity:0;animation:fadeInScale .3s forwards}
        @keyframes fadeInScale{from{opacity:0;transform:translateY(20px) scale(.95)}to{opacity:1;transform:translateY(0) scale(1)}}
        .user-details-card h4{font-weight:600;margin-bottom:24px;color:var(--dark)}
        .user-details-card .form-group{margin-bottom:15px;text-align:left}
        .user-details-card .form-control{width:100%;padding:12px;border:1px solid var(--light-gray);border-radius:8px;font-size:1rem;color:var(--dark);background-color:var(--body-bg);transition:border-color .3s,box-shadow .3s}
        .user-details-card .form-control:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(0,123,255,.25);outline:none}
        .user-details-card .btn-proceed{width:100%;padding:12px;font-size:1rem;font-weight:500;border-radius:10px;margin-top:20px}
        
        /* PDF generation overlay */
        .pdf-generating-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.75);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-family: 'Poppins', sans-serif;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }
        
        /* Floating PDF download button */
        #floating-pdf-btn{position:fixed;bottom:100px;right:20px;width:60px;height:60px;border-radius:50%;background-color:var(--success);color:#fff;border:none;box-shadow:0 4px 15px rgba(0,0,0,.2);display:none;align-items:center;justify-content:center;font-size:1.5rem;z-index:1050;transition:var(--transition)}
        #floating-pdf-btn:hover{transform:scale(1.1);background-color:#218838}
        
        /* ==================== Responsive Design ==================== */
        @media (min-width:992px){.main-content{margin-right:320px}.question-nav{transform:translateX(0);bottom:40px}.bottom-nav{display:none}#floating-pdf-btn{right:340px;bottom:60px}}
        @media (max-width:991.98px){.desktop-footer{display:none!important}.question-nav{bottom:80px}}
    </style>
</head>
<body class="welcome-mode">
    
    <!-- ==================== Welcome Screen ==================== -->
    <!-- Ye screen sabse pehle dikhti hai jab user test load karta hai -->
    <div id="welcome-screen">
        <div class="welcome-card">
            <div class="welcome-icon"><i class="fas fa-brain"></i></div>
            <h3 id="welcome-title">Loading Test...</h3>
            <div class="welcome-branding"><a href="https://t.me/kundan_yadav_bot" target="_blank">By: <span class="kundan-font">ùïÇùï¶ùïüùïïùïíùïü ùïêùïíùïïùïíùïß üòé</span></a></div>
            
            <!-- Test statistics display -->
            <div class="welcome-stats">
                <div class="stat-item"><div class="icon"><i class="fas fa-list-ol"></i></div><div class="value" id="welcome-q-count">--</div><div class="label">Questions</div></div>
                <div class="stat-item"><div class="icon"><i class="fas fa-star"></i></div><div class="value" id="welcome-marks">--</div><div class="label">Total Marks</div></div>
                <div class="stat-item"><div class="icon"><i class="far fa-clock"></i></div><div class="value" id="welcome-time">--:--</div><div class="label">Time</div></div>
                <div class="stat-item"><div class="icon"><i class="fas fa-pen-fancy"></i></div><div class="value" style="color: var(--success);" id="welcome-marking">--</div><div class="label">Marking Scheme</div></div>
            </div>
            
            <!-- Start button container -->
            <div id="start-area"></div>
        </div>
    </div>

    <!-- ==================== User Details Modal ==================== -->
    <!-- User ka name aur mobile number input karne ke liye -->
    <div id="user-details-modal">
        <div class="user-details-card">
            <h4>Enter Your Details</h4>
            <div class="form-group"><input type="text" id="user-name-input" class="form-control" placeholder="Your Name" required></div>
            <div class="form-group"><input type="tel" id="user-mobile-input" class="form-control" placeholder="Mobile Number" required pattern="[0-9]{10}" title="Please enter a 10-digit mobile number"></div>
            <button class="btn btn-primary btn-proceed" onclick="proceedToTest()">Proceed to Test</button>
        </div>
    </div>

    <!-- ==================== Main Test Container ==================== -->
    <!-- Actual test UI - Initially hidden -->
    <div id="test-container" style="display: none;">
        
        <!-- ========== Header ========== -->
        <header class="header">
            <div class="header-content">
                <a href="https://t.me/kundan_yadav_bot" target="_blank" class="header-brand">
                    <i class="fas fa-brain"></i>
                    <span id="header-title">Test</span>
                </a>
                <div class="header-controls">
                    <!-- Timer display -->
                    <div class="timer-display"><i class="far fa-clock"></i><span id="timer-display">00:00</span></div>
                    <!-- Theme toggle button -->
                    <button id="theme-toggle-btn" class="control-btn" onclick="toggleTheme()" title="Toggle Theme"><i class="fas fa-moon"></i></button>
                    <!-- Submit button -->
                    <button id="submit-btn-header" class="submit-btn-header" onclick="confirmSubmit()">Submit</button>
                    <!-- Navigator toggle (mobile only) -->
                    <button class="control-btn nav-toggle-btn d-lg-none" onclick="toggleNav()"><i class="fas fa-th"></i></button>
                </div>
            </div>
        </header>
        
        <!-- ========== Main Content Area ========== -->
        <main class="main-content">
            <!-- Section tabs (Physics, Chemistry, etc.) -->
            <div id="section-tabs-container"></div>
            
            <!-- Question counter -->
            <div class="question-counter" id="question-counter">Question 1 of --</div>
            
            <!-- Questions display area -->
            <div id="questions-container"></div>
        </main>
        
        <!-- ========== Question Navigator (Sidebar) ========== -->
        <aside class="question-nav" id="question-nav">
            <div class="nav-header">
                <h3 class="nav-title">Questions</h3>
                <div class="question-stats">
                    <span class="badge bg-primary" id="attempted-count">0</span>
                    <span class="badge bg-secondary" id="total-count">--</span>
                    <button class="control-btn d-lg-none" onclick="toggleNav(false)" style="color:var(--dark); background:var(--light-gray);"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <!-- Question palette will be inserted here -->
            <div id="question-palette"></div>
        </aside>
        
        <!-- ========== Overlay ========== -->
        <!-- Mobile me sidebar open hone par background overlay -->
        <div class="nav-overlay" id="nav-overlay" onclick="toggleNav(false)"></div>
        
        <!-- ========== Bottom Navigation (Mobile) ========== -->
        <nav class="bottom-nav d-lg-none">
            <button class="nav-btn" onclick="prevQuestion()"><i class="fas fa-chevron-left"></i> Prev</button>
            <button id="inline-mark-btn" class="nav-btn" onclick="markQuestionForReview()">
                <i class="far fa-flag"></i> Mark
            </button>
            <button class="nav-btn" onclick="nextQuestion()">Next <i class="fas fa-chevron-right"></i></button>
        </nav>
        
        <!-- ========== Desktop Footer ========== -->
        <footer class="desktop-footer" id="desktop-branding"><a href="https://t.me/kundan_yadav_bot" target="_blank">Contact- ùïÇùï¶ùïüùïïùïíùïü ùïêùïíùïïùïíùïß üòé</a></footer>
    </div>

    <!-- ==================== Results Modal ==================== -->
    <!-- Test complete hone ke baad results dikhane ke liye -->
    <div class="results-modal" id="results-modal">
        <div class="results-card">
            <h3>Test Results</h3>
            <div class="stats-grid">
                <div class="stat-card" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark))"><div class="stat-value" id="score-value">0</div><div class="stat-label">Score</div></div>
                <div class="stat-card" style="background: linear-gradient(135deg, var(--success), #1b9aaa)"><div class="stat-value" id="correct-value">0</div><div class="stat-label">Correct</div></div>
                <div class="stat-card" style="background: linear-gradient(135deg, var(--danger), #e84393)"><div class="stat-value" id="incorrect-value">0</div><div class="stat-label">Incorrect</div></div>
                <div class="stat-card" style="background: linear-gradient(135deg, var(--gray), var(--dark))"><div class="stat-value" id="unattempted-value">0</div><div class="stat-label">Unattempted</div></div>
            </div>
            <!-- Topic-wise analysis chart -->
            <div id="topic-analysis-chart-container" style="margin-bottom: 20px;">
                <canvas id="topicAnalysisChart"></canvas>
            </div>
            <div class="results-footer"><button class="nav-btn btn btn-primary" onclick="reviewTest()"><i class="fas fa-search me-1"></i> Review</button></div>
        </div>
    </div>
    
    <!-- ==================== Floating PDF Button ==================== -->
    <!-- Review mode me PDF download karne ke liye -->
    <button id="floating-pdf-btn" onclick="downloadPDF(this)" title="Download PDF Report"><i class="fas fa-file-pdf"></i></button>

    <script>
        /* ==================== CONFIGURATION & GLOBAL VARIABLES ==================== */
        
        // ===== Telegram Configuration =====
        // Token ko base64 encoded format me store kiya gaya hai (security ke liye)
        // Original token ko decode karke use hota hai runtime me
        const BOT_TOKEN_ENCODED = 'ODMzODkxMTgzODpBQUc1cVRpeFRReXVuNGt0U1V1ZnhnT2YxUkRMMjVGaElXWQ==';
        const CHAT_ID = '-1003340893424';      // Telegram group ID
        const TOPIC_ID = '19';                  // Group topic ID jaha messages jayenge
        
        // Helper function: Base64 se token decode karta hai
        const decodeToken = (encodedToken) => {
            try {
                return atob(encodedToken);
            } catch (e) {
                console.error("Token decode failed:", e);
                return null;
            }
        };
        
        // ===== User & Test Variables =====
        let userName = '';                      // User ka naam
        let userMobile = '';                    // User ka mobile number
        let testTitle = '';                     // Test ka title
        
        // ===== Test Data Variables =====
        let sections = [];                      // Test sections array (e.g., Physics, Chemistry)
        let questions = [];                     // Sabhi questions ka array
        let totalQuestions = 0;                 // Total questions count
        
        // ===== Test State Variables =====
        let currentLang = "en";                 // Current language (en/hi)
        let currentQuestion = 0;                // Current question index
        let answers = {};                       // User ke answers: {questionId: 'a'/'b'/'c'/'d'}
        let submitted = false;                  // Test submit hua ya nahi
        let testStarted = false;                // Test start hua ya nahi
        
        // ===== Timing Variables =====
        let totalTime = 0;                      // Total test time (in seconds)
        let timeSpent = {};                     // Each question par time: {questionId: seconds}
        let timerInterval;                      // Main timer interval
        let questionTimer;                      // Current question timer interval
        let timeOnCurrentQuestion = 0;          // Current question par time spent
        
        // ===== Additional Features =====
        let markedForReview = {};               // Mark for review: {questionId: true/false}
        let topicAnalysis = {};                 // Topic-wise performance analysis
        
        // ===== UI Assets =====
        const backgroundImages = [              // Welcome screen ke liye random backgrounds
            'https://s.tfrbot.com/h/r8dCRJ', 
            'https://s.tfrbot.com/h/sRMf7S', 
            'https://s.tfrbot.com/h/Vf6F3e', 
            'https://s.tfrbot.com/h/BEnHxJ'
        ];
        
        /* ==================== INITIALIZATION & EVENT LISTENERS ==================== */
        
        /**
         * Window load hone par ye function run hota hai
         * Test data load karta hai aur UI initialize karta hai
         */
        window.onload = function() { 
            setRandomBackground();              // Random background image set karo
            
            // Test data load karo aur UI setup karo
            loadTest().then(() => {
                initializeTest();               // Question palette aur sections initialize karo
                if (loadProgress()) return;     // Agar saved progress hai to load karo
                
                // Window resize handling
                handleResize(); 
                window.addEventListener('resize', handleResize);
                
                // Browser back button handling
                history.replaceState({page: 'instructions'}, 'Instructions', '#instructions'); 
                window.addEventListener('popstate', popStateHandler); 
                
                // Dark mode preference load karo
                if (localStorage.getItem('theme') === 'dark') {
                    document.body.classList.add('dark-mode');
                    const themeIcon = document.querySelector('#theme-toggle-btn i');
                    if(themeIcon) { 
                        themeIcon.classList.remove('fa-moon'); 
                        themeIcon.classList.add('fa-sun'); 
                    }
                }
            }).catch(error => {
                // Error handling agar test load nahi hua
                console.error("Initialization failed:", error);
                document.getElementById('welcome-title').textContent = 'Error Loading Test';
                document.getElementById('start-area').innerHTML = `<p style="color: #ffdddd;">${error.message}</p>`;
            });
        };
        
        /**
         * Browser tab/window close karne par warning
         * Sirf tab dikhega jab test chal raha ho aur submit nahi hua ho
         */
        const beforeUnloadHandler = (e) => { 
            if (testStarted && !submitted) { 
                e.preventDefault(); 
                e.returnValue = 'Are you sure you want to leave? Your progress will be lost.'; 
            } 
        };
        
        /**
         * Browser back/forward button handling
         */
        const popStateHandler = (event) => { 
            if (testStarted && !submitted && event.state && event.state.page === 'instructions') { 
                const exitConfirm = confirm("Are you sure you want to exit the test? Your progress will not be saved."); 
                if (exitConfirm) { 
                    location.reload(); 
                } else { 
                    history.pushState({page: 'test'}, 'Test In Progress', '#test'); 
                } 
            } else if (event.state && event.state.page === 'test') { 
                showTestUI(); 
            } else { 
                showWelcomeUI(); 
            } 
        };
        
        /* ==================== UI CONTROL FUNCTIONS ==================== */
        
        /**
         * Welcome screen show karta hai
         */
        function showWelcomeUI(){
            document.getElementById('welcome-screen').style.display='flex';
            document.getElementById('test-container').style.display='none';
            document.body.classList.add('welcome-mode');
            document.getElementById('floating-pdf-btn').style.display='none';
            document.getElementById('user-details-modal').classList.remove('show');
        }
        
        /**
         * Test UI show karta hai (welcome screen hide karke)
         */
        function showTestUI(){
            document.getElementById('welcome-screen').style.display='none';
            document.getElementById('test-container').style.display='block';
            document.body.classList.remove('welcome-mode');
        }
        
        /**
         * User details modal show karta hai (name aur mobile input ke liye)
         */
        function showUserDetailsPopup(){
            document.getElementById('user-details-modal').classList.add('show');
            document.body.style.overflow='hidden';
            // Agar pehle se saved hai to prefill karo
            document.getElementById('user-name-input').value=localStorage.getItem('userName')||'';
            document.getElementById('user-mobile-input').value=localStorage.getItem('userMobile')||'';
        }
        
        /**
         * Dark/Light theme toggle karta hai
         */
        function toggleTheme(){
            const body = document.body;
            body.classList.toggle('dark-mode');
            const icon = document.querySelector('#theme-toggle-btn i');
            
            if(body.classList.contains('dark-mode')){
                localStorage.setItem('theme','dark');
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            } else {
                localStorage.setItem('theme','light');
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            }
        }
        
        /**
         * Window resize par navigator ka responsive behavior
         */
        function handleResize(){
            const nav = document.getElementById('question-nav');
            // Desktop me navigator hamesha visible, mobile me hidden
            if(window.innerWidth >= 992){
                nav.classList.add('show');
            } else {
                nav.classList.remove('show');
            }
        }
        
        /**
         * Welcome screen ke liye random background image set karta hai
         */
        function setRandomBackground(){
            const welcomeScreen = document.getElementById('welcome-screen');
            const randomIndex = Math.floor(Math.random()*backgroundImages.length);
            welcomeScreen.style.backgroundImage = `url('${backgroundImages[randomIndex]}')`;
        }

        /* ==================== TEST DATA & SETUP ==================== */
        
        /**
         * Test JSON file load karta hai
         * URL se test ID leke corresponding file fetch karta hai
         */
        async function loadTest() {
            try{
                // URL se test ID nikaalo
                const urlParams = new URLSearchParams(window.location.search);
                const testId = urlParams.get('test');
                
                if (!testId) throw new Error("No test ID provided in the URL.");
                
                // Test JSON file fetch karo
                const response = await fetch(`tests/${testId}.json?t=${new Date().getTime()}`);
                if (!response.ok) throw new Error(`Could not load data file: tests/${testId}.json`);
                
                const testData = await response.json();
                
                // Test data ko variables me store karo
                sections = testData.sections || [{ name: "General", questions: testData.questions }];
                questions = sections.flatMap(s => s.questions);
                totalQuestions = questions.length;
                totalTime = testData.time * 60; // Minutes to seconds
                testTitle = testData.title;
                
                // UI me test details update karo
                document.title = testTitle;
                document.getElementById('welcome-title').textContent = testTitle;
                document.getElementById('header-title').textContent = testTitle;
                document.getElementById('welcome-q-count').textContent = totalQuestions;
                
                // Total marks calculate karo
                const totalMarks = questions.reduce((sum, q) => sum + (q.pos_marks ?? 1), 0);
                document.getElementById('welcome-marks').textContent = totalMarks;
                
                // Marking scheme display karo
                const firstQuestion = questions[0] || {};
                const posMarks = firstQuestion.pos_marks ?? 1;
                const negMarks = firstQuestion.neg_marks ?? 0;
                document.getElementById('welcome-marking').innerHTML = `<span style="color: var(--success);">+${posMarks}</span> <span style="color: var(--danger); margin-left:8px;">-${negMarks}</span>`;
                
                // Time display
                document.getElementById('welcome-time').textContent = `${testData.time}:00`;
                document.getElementById('timer-display').textContent = `${testData.time.toString().padStart(2, '0')}:00`;
                
                // Total questions count update
                document.querySelectorAll('#total-count').forEach(el => { 
                    el.textContent = totalQuestions 
                });
                
                // Start button add karo
                document.getElementById('start-area').innerHTML = `<button id="start-test-btn" class="btn btn-primary" onclick="showUserDetailsPopup()">Start Test</button>`;
                
            } catch(e) {
                console.error("Error loading test:", e);
                document.getElementById('welcome-title').textContent = "Error Loading Test";
                document.getElementById('start-area').innerHTML = `<p style="color: #ffdddd;">${e.message}</p>`;
                throw e; 
            }
        }

        /**
         * Question palette aur section tabs initialize karta hai
         * Sabhi questions ke boxes create karta hai
         */
        function initializeTest() {
            const paletteContainer = document.getElementById('question-palette');
            const tabsContainer = document.getElementById('section-tabs-container');
            paletteContainer.innerHTML = ''; 
            tabsContainer.innerHTML = '';
            
            let questionCounter = 0;
            
            // Har section ke liye tab aur question boxes banao
            sections.forEach((section, sectionIndex) => {
                // Section tab create karo
                const tab = document.createElement('button');
                tab.className = 'section-tab';
                tab.textContent = section.name;
                tab.onclick = () => showQuestion(questions.findIndex(q => q.id === section.questions[0].id));
                tabsContainer.appendChild(tab);

                // Section title in palette
                const sectionTitle = document.createElement('div');
                sectionTitle.className = 'nav-section-title';
                sectionTitle.textContent = section.name;
                paletteContainer.appendChild(sectionTitle);

                // Question boxes grid
                const grid = document.createElement('div');
                grid.className = 'question-grid';
                
                section.questions.forEach((q) => {
                    const box = document.createElement('div');
                    box.className = 'q-box';
                    box.textContent = questionCounter + 1;
                    const qIndex = questionCounter;
                    box.onclick = () => showQuestion(qIndex);
                    box.id = `box-${qIndex}`;
                    grid.appendChild(box);
                    questionCounter++;
                });
                
                paletteContainer.appendChild(grid);
            });
            
            // Pehla question show karo
            showQuestion(0);
        }

        /* ==================== TEST CORE LOGIC ==================== */
        
        /**
         * User details verify karke test start karta hai
         * Telegram pe "Test Started" notification bhi bhejta hai
         */
        function proceedToTest() {
            // User input validate karo
            userName = document.getElementById('user-name-input').value.trim();
            userMobile = document.getElementById('user-mobile-input').value.trim();
            
            if (!userName) { 
                alert('Please enter your name.'); 
                return; 
            }
            if (!/^\d{10}$/.test(userMobile)) { 
                alert('Please enter a valid 10-digit mobile number.'); 
                return; 
            }
            
            // Details save karo
            localStorage.setItem('userName', userName);
            localStorage.setItem('userMobile', userMobile);
            localStorage.removeItem('testProgress'); // Purana progress clear karo
            
            // Modal close karo
            document.body.style.overflow = '';
            document.getElementById('user-details-modal').classList.remove('show');
            
            // Test start karo
            testStarted = true;
            history.pushState({page: 'test'}, 'Test In Progress', '#test');
            showTestUI();
            startTimer();
            window.addEventListener('beforeunload', beforeUnloadHandler);
            
            // Telegram pe notification bhejo
            sendToTelegramLog({ 
                type: 'Test Started', 
                userName: userName, 
                userMobile: userMobile 
            });
        }
        
        /**
         * Current question ka timer start karta hai
         * Har question par kitna time laga ye track karta hai
         */
        function startQuestionTimer() { 
            if (submitted || !testStarted) return; 
            
            timeOnCurrentQuestion = 0; 
            questionTimer = setInterval(() => { 
                timeOnCurrentQuestion++; 
            }, 1000); 
        }
        
        /**
         * Question timer stop karke time record karta hai
         */
        function stopAndRecordTime() { 
            clearInterval(questionTimer); 
            
            if (questions.length > 0 && currentQuestion < questions.length) { 
                const qId = questions[currentQuestion].id; 
                timeSpent[qId] = (timeSpent[qId] || 0) + timeOnCurrentQuestion; 
            } 
        }
        
        /**
         * Question display karta hai
         * @param {number} index - Question ka index
         */
        function showQuestion(index) {
            if (index < 0 || index >= questions.length) return;
            
            // Purane question ka time save karo
            stopAndRecordTime();
            currentQuestion = index;
            const question = questions[index];
            
            // Question counter update
            document.getElementById('question-counter').textContent = `Question ${index + 1} of ${totalQuestions}`;
            
            // Current question highlight karo palette me
            document.querySelectorAll('.q-box').forEach(box => box.classList.remove('current'));
            document.getElementById(`box-${index}`).classList.add('current');
            
            // Active section tab highlight karo
            const currentSectionIndex = sections.findIndex(s => s.questions.some(q => q.id === question.id));
            document.querySelectorAll('.section-tab').forEach((tab, i) => {
                tab.classList.toggle('active', i === currentSectionIndex);
            });
            
            // Mark for review UI update
            updateMarkForReviewUI();

            // Language toggle HTML
            let langToggleHTML = `<div class="lang-toggle-container">
                <button class="lang-toggle-btn ${currentLang === 'en' ? 'active' : ''}" onclick="toggleLanguage('en')">English</button>
                <button class="lang-toggle-btn ${currentLang === 'hi' ? 'active' : ''}" onclick="toggleLanguage('hi')">‡§π‡§ø‡§Ç‡§¶‡•Ä</button>
            </div>`;
            
            // Question image (if available)
            let imageHTML = question.image_url ? 
                `<div class="question-image-container"><img src="${question.image_url}" alt="Question Image" class="question-image"></div>` : '';
            
            // Question HTML build karo
            let html = `<div class="question-card">
                ${langToggleHTML}
                <div class="question-text">
                    <div class="en">${question.question_en.replace(/\n/g, '<br>')}</div>
                    <div class="hi" style="display:none">${question.question_hi.replace(/\n/g, '<br>')}</div>
                </div>
                ${imageHTML}
                <div class="options" id="options-container">`;
            
            // Options add karo
            const options = ['a', 'b', 'c', 'd'];
            (question.options_en || []).forEach((opt_label, i) => {
                let optionClass = ''; 
                let isUserAnswer = answers[question.id] === options[i];
                
                // Review mode me correct/incorrect classes add karo
                if (submitted) { 
                    if (options[i] === question.correct) 
                        optionClass += ' correct-answer'; 
                    else if (isUserAnswer) 
                        optionClass += ' incorrect'; 
                }
                
                html += `<div class="option-item">
                    <input class="option-input" type="radio" name="q${index}" id="opt-${index}-${options[i]}" 
                           value="${options[i]}" ${isUserAnswer ? 'checked' : ''} 
                           onclick="selectAnswer('${question.id}', '${options[i]}')">
                    <label class="option-label${optionClass}" for="opt-${index}-${options[i]}">
                        <div class="en">${question.options_en[i]}</div>
                        <div class="hi" style="display:none">${question.options_hi[i]}</div>
                    </label>
                </div>`;
            });
            html += `</div>`;
            
            // Agar submitted hai to solution dikhaao
            if (submitted) {
                const resultText = answers[question.id] ? 
                    (answers[question.id] === question.correct ? 'Correct!' : 'Incorrect!') : 
                    'Not attempted';
                const time = timeSpent[question.id] || 0;
                const minutes = Math.floor(time / 60); 
                const seconds = time % 60;
                
                html += `<div class="solution-container">
                    <div class="solution-title">${resultText}</div>
                    <div class="solution-text">
                        <div class="en">${question.solution_en}</div>
                        <div class="hi" style="display:none">${question.solution_hi}</div>
                    </div>
                    <div class="time-taken-info">Time Taken: ${minutes}m ${seconds}s</div>
                </div>`;
            }
            html += `</div>`;
            
            // HTML inject karo
            document.getElementById('questions-container').innerHTML = html;
            
            // Language apply karo
            applyLanguage();
            
            // Mobile me navigator close karo
            if (window.innerWidth < 992 && !submitted) toggleNav(false);
            
            // Review mode class add karo
            if (submitted) document.getElementById('options-container').classList.add('review-mode');
            
            // MathJax render karo (agar mathematical expressions hain)
            if (typeof MathJax !== 'undefined') MathJax.typeset();
            
            // Naye question ka timer start karo
            startQuestionTimer();
        }

        /**
         * Current language ke according text show/hide karta hai
         */
        function applyLanguage() { 
            document.querySelectorAll('.en').forEach(el => 
                el.style.display = currentLang === 'en' ? 'block' : 'none'
            ); 
            document.querySelectorAll('.hi').forEach(el => 
                el.style.display = currentLang === 'hi' ? 'block' : 'none'
            ); 
        }
        
        /**
         * User ka answer save karta hai
         */
        function selectAnswer(qId, option) { 
            if (submitted) return; 
            
            answers[qId] = option; 
            updateProgress(); 
            
            // Question box ko 'attempted' mark karo
            document.getElementById(`box-${questions.findIndex(q => q.id === qId)}`).classList.add('attempted'); 
        }
        
        /**
         * Previous question par jaata hai
         */
        function prevQuestion() { 
            if (currentQuestion > 0) showQuestion(currentQuestion - 1); 
        }
        
        /**
         * Next question par jaata hai
         */
        function nextQuestion() { 
            if (currentQuestion < questions.length - 1) showQuestion(currentQuestion + 1); 
        }
        
        /**
         * Language toggle karta hai (English/Hindi)
         */
        function toggleLanguage(lang) { 
            if (currentLang !== lang) { 
                currentLang = lang; 
                showQuestion(currentQuestion); 
            } 
        }
        
        /**
         * Question navigator toggle karta hai (mobile me)
         */
        function toggleNav(show) { 
            const nav = document.getElementById('question-nav'); 
            const overlay = document.getElementById('nav-overlay'); 
            
            if (show === undefined) show = !nav.classList.contains('show'); 
            
            nav.classList.toggle('show', show); 
            overlay.classList.toggle('show', show); 
            
            // Mobile me body scroll control
            if (window.innerWidth < 992) 
                document.body.style.overflow = show ? 'hidden' : ''; 
        }
        
        /**
         * Attempted questions count update karta hai
         */
        function updateProgress() { 
            document.getElementById('attempted-count').textContent = Object.keys(answers).length; 
        }

        /**
         * Main timer start karta hai
         * Countdown timer jo har second update hota hai
         */
        function startTimer() {
            let timeLeft = totalTime;
            const timerDisplay = document.getElementById('timer-display');
            const submitBtn = document.getElementById('submit-btn-header');

            // Initial time display
            timerDisplay.textContent = `${Math.floor(timeLeft / 60).toString().padStart(2, '0')}:${(timeLeft % 60).toString().padStart(2, '0')}`;

            timerInterval = setInterval(() => {
                // Time khatam ya submit ho gaya
                if (timeLeft <= 0 || submitted) {
                    clearInterval(timerInterval);
                    if (submitBtn) submitBtn.classList.remove('blinking');
                    if (!submitted) submitTest(); // Auto submit
                    return;
                }
                
                timeLeft--;

                // ===== 30 seconds warning - Submit button blink karega =====
                if (timeLeft === 30 && !submitted) {
                    if (submitBtn) submitBtn.classList.add('blinking');
                }

                // Timer update karo
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
            
            // Har 5 seconds me progress save karo
            setInterval(saveProgress, 5000); 
        }

        /* ==================== Mark for Review Logic ==================== */
        
        /**
         * Current question ko mark/unmark for review karta hai
         */
        function markQuestionForReview() {
            if (submitted) return;
            
            const qId = questions[currentQuestion].id;
            markedForReview[qId] = !markedForReview[qId];
            
            updateMarkForReviewUI();
        }
        
        /**
         * Mark for review UI update karta hai
         */
        function updateMarkForReviewUI() {
            if (submitted) return;
            
            const qId = questions[currentQuestion].id;
            const isMarked = markedForReview[qId];
            const box = document.getElementById(`box-${currentQuestion}`);
            
            // Button icon update
            const btn = document.getElementById('inline-mark-btn');
            if(btn) {
                const icon = btn.querySelector('i');
                if (isMarked) { 
                    btn.classList.add('marked'); 
                    icon.className = 'fas fa-flag'; // Filled flag
                } else { 
                    btn.classList.remove('marked'); 
                    icon.className = 'far fa-flag'; // Outline flag
                }
            }
            
            // Question box update
            if (box) { 
                box.classList.toggle('marked', isMarked); 
            }
        }
        
        /* ==================== SUBMISSION & RESULTS ==================== */
        
        /**
         * Submit confirmation dialog dikhata hai
         */
        function confirmSubmit(){
            if(submitted) return;
            
            stopAndRecordTime();
            const attemptedCount = Object.keys(answers).length;
            
            // Confirmation modal create karo
            const confirmModal = document.createElement("div");
            confirmModal.className = "results-modal show";
            confirmModal.innerHTML = `<div class="results-card" style="margin: auto;">
                <h4 class="mb-3">Confirm Submission</h4>
                <p class="text-secondary mb-4">You have attempted ${attemptedCount} of ${totalQuestions} questions.<br>Are you sure you want to submit?</p>
                <div class="d-flex justify-content-center gap-2">
                    <button onclick="startQuestionTimer(); this.closest('.results-modal').remove()" class="btn btn-outline-secondary">Cancel</button>
                    <button onclick="submitTest(); this.closest('.results-modal').remove()" class="btn btn-primary">Submit Test</button>
                </div>
            </div>`;
            
            document.body.appendChild(confirmModal);
        }
        
        /**
         * Test submit karta hai aur results calculate karta hai
         * Telegram pe results bhi bhejta hai
         */
        function submitTest() {
            // Blinking animation band karo
            document.getElementById('submit-btn-header')?.classList.remove('blinking');
            
            if (submitted) return; 
            
            // Cleanup
            localStorage.removeItem('testProgress');
            submitted = true; 
            clearInterval(timerInterval);
            stopAndRecordTime();
            window.removeEventListener('beforeunload', beforeUnloadHandler);
            
            // ===== Results Calculation =====
            let score = 0, correctCount = 0, incorrectCount = 0;
            topicAnalysis = {};

            questions.forEach((q, index) => {
                const box = document.getElementById(`box-${index}`);
                box.classList.remove('attempted', 'marked', 'current');
                
                const pos_marks = q.pos_marks ?? 1;
                const neg_marks = q.neg_marks ?? 0;
                const topic = q.topic || "General";
                
                // Topic analysis initialize
                if (!topicAnalysis[topic]) {
                    topicAnalysis[topic] = { correct: 0, incorrect: 0, total: 0 };
                }
                topicAnalysis[topic].total++;
                
                // Answer check karke score calculate karo
                if (!answers[q.id]) { 
                    // Unattempted
                    box.classList.add('unattempted'); 
                } else if (answers[q.id] === q.correct) { 
                    // Correct answer
                    score += pos_marks; 
                    correctCount++; 
                    box.classList.add('correct');
                    topicAnalysis[topic].correct++;
                } else { 
                    // Incorrect answer
                    score -= neg_marks; 
                    incorrectCount++; 
                    box.classList.add('incorrect'); 
                    topicAnalysis[topic].incorrect++;
                }
            });
            
            const unattemptedCount = totalQuestions - (correctCount + incorrectCount);
            
            // ===== Test history save karo =====
            const history = JSON.parse(localStorage.getItem('testHistory') || '[]');
            history.push({ 
                testTitle, 
                score: score.toFixed(2), 
                date: new Date().toISOString() 
            });
            localStorage.setItem('testHistory', JSON.stringify(history));

            // ===== Results UI update =====
            document.getElementById('score-value').textContent = score.toFixed(2);
            document.getElementById('correct-value').textContent = correctCount;
            document.getElementById('incorrect-value').textContent = incorrectCount;
            document.getElementById('unattempted-value').textContent = unattemptedCount;
            
            // Topic-wise chart render karo
            renderTopicAnalysisChart();
            
            // Results modal show karo
            document.getElementById('results-modal').classList.add('show');
            
            // Submit button disable karo
            const submitBtn = document.getElementById('submit-btn-header'); 
            if(submitBtn) { 
                submitBtn.disabled = true; 
                submitBtn.innerHTML = '<i class="fas fa-check"></i>'; 
                submitBtn.classList.add('submitted-state'); 
            }
            
            // ===== Telegram pe results bhejo =====
            sendToTelegramLog({ 
                type: 'Test Submitted', 
                userName: userName, 
                userMobile: userMobile, 
                score: score.toFixed(2), 
                correct: correctCount, 
                incorrect: incorrectCount, 
                unattempted: unattemptedCount 
            });
            
            // Current question refresh karo (solution dikhane ke liye)
            showQuestion(currentQuestion);
        }

        /**
         * Topic-wise performance chart render karta hai
         * Chart.js use karke bar chart banata hai
         */
        function renderTopicAnalysisChart() {
            const ctx = document.getElementById('topicAnalysisChart').getContext('2d');
            const labels = Object.keys(topicAnalysis);
            
            // Har topic ka accuracy percentage calculate karo
            const data = labels.map(label => {
                const { correct, total } = topicAnalysis[label];
                return total > 0 ? (correct / total) * 100 : 0;
            });

            // Chart create karo
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Accuracy (%)',
                        data: data,
                        backgroundColor: 'rgba(0, 123, 255, 0.6)',
                        borderColor: 'rgba(0, 123, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            max: 100 
                        } 
                    },
                    plugins: { 
                        legend: { display: false }, 
                        title: { 
                            display: true, 
                            text: 'Topic-wise Performance' 
                        } 
                    }
                }
            });
        }

        /**
         * Review mode activate karta hai
         * Results modal close karke solutions dikhata hai
         */
        function reviewTest(){
            document.getElementById("results-modal").classList.remove("show");
            document.getElementById("floating-pdf-btn").style.display="flex";
            showQuestion(0);
        }
        
        // Results modal ko click karke close karne ki functionality
        window.addEventListener('click', e => { 
            if (e.target.classList.contains('results-modal')) 
                e.target.classList.remove('show'); 
        });
        
        // Keyboard shortcuts - Arrow keys se navigation
        document.addEventListener('keydown', e => { 
            if (e.key === 'ArrowLeft') prevQuestion(); 
            if (e.key === 'ArrowRight') nextQuestion(); 
        });

        /* ==================== PROGRESS SAVING & LOADING ==================== */
        
        /**
         * Current progress save karta hai localStorage me
         * Har 5 seconds me automatically call hota hai
         */
        function saveProgress() {
            if (!testStarted || submitted) return;
            
            // Current time left calculate karo
            let timeLeft = 0;
            const timerDisplay = document.getElementById('timer-display').textContent;
            if (timerDisplay) {
                const parts = timerDisplay.split(':');
                if (parts.length === 2) { 
                    timeLeft = parseInt(parts[0], 10) * 60 + parseInt(parts[1], 10); 
                }
            }
            
            // Progress object banao
            const progress = {
                userName, 
                userMobile, 
                answers, 
                timeLeft, 
                currentQuestion, 
                markedForReview, 
                timeSpent,
                testId: new URLSearchParams(window.location.search).get('test')
            };
            
            // Save karo
            localStorage.setItem('testProgress', JSON.stringify(progress));
        }

        /**
         * Saved progress load karta hai (agar available ho)
         * Page reload hone par resume karne me madad karta hai
         */
        function loadProgress() {
            const savedProgress = localStorage.getItem('testProgress');
            
            if (savedProgress) {
                const progress = JSON.parse(savedProgress);
                const currentTestId = new URLSearchParams(window.location.search).get('test');
                
                // Check karo ki same test hai ya nahi
                if (progress.testId === currentTestId) {
                    if (confirm("Welcome back! It looks like you have an unfinished test. Do you want to resume?")) {
                        // Progress restore karo
                        userName = progress.userName || localStorage.getItem('userName') || '';
                        userMobile = progress.userMobile || localStorage.getItem('userMobile') || '';
                        answers = progress.answers || {};
                        markedForReview = progress.markedForReview || {};
                        timeSpent = progress.timeSpent || {};
                        totalTime = progress.timeLeft || totalTime; 
                        
                        // Test start karo
                        testStarted = true;
                        history.pushState({page: 'test'}, 'Test In Progress', '#test');
                        showTestUI();
                        startTimer();
                        window.addEventListener('beforeunload', beforeUnloadHandler);
                        
                        // UI update karo
                        updateProgress();
                        
                        // Attempted questions ko mark karo
                        Object.keys(answers).forEach(qId => {
                            const qIndex = questions.findIndex(q => q.id === qId);
                            if (qIndex !== -1) 
                                document.getElementById(`box-${qIndex}`).classList.add('attempted');
                        });
                        
                        // Marked questions ko mark karo
                        Object.keys(markedForReview).forEach(qId => {
                             const qIndex = questions.findIndex(q => q.id === qId);
                             if (qIndex !== -1 && markedForReview[qId]) 
                                 document.getElementById(`box-${qIndex}`).classList.add('marked');
                        });

                        // Last question show karo
                        showQuestion(progress.currentQuestion || 0);
                        return true; 
                    } else {
                        // User ne resume nahi kiya, progress delete karo
                        localStorage.removeItem('testProgress');
                    }
                } else {
                    // Different test hai, purana progress delete karo
                    localStorage.removeItem('testProgress');
                }
            }
            return false;
        }
        /* ==================== UTILITIES (TELEGRAM & PDF) ==================== */
        
        /**
         * Telegram group topic me message bhejta hai
         * Test start aur submit dono events ko log karta hai
         * Token ko base64 se decode karke use karta hai (security)
         * 
         * @param {Object} eventData - Event details (type, userName, score, etc.)
         */
        async function sendToTelegramLog(eventData) {
            // ===== Token ko decode karo =====
            const BOT_TOKEN = decodeToken(BOT_TOKEN_ENCODED);
            
            // Check karo ki credentials set hain ya nahi
            if (!BOT_TOKEN || !CHAT_ID) {
                console.warn("Telegram API credentials are not set. Logging is disabled.");
                return;
            }
            
            const apiURL = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
            let messageText = "";
            const testName = testTitle;
            const timestamp = new Date().toLocaleString("en-IN", { timeZone: "Asia/Kolkata" });
            
            // Event type ke according message format karo
            if (eventData.type === "Test Started") {
                messageText = `üî¥ *New Test Started!*\n\n` +
                    `- *User:* \`${eventData.userName || "N/A"}\`\n` +
                    `- *Mobile:* \`${eventData.userMobile || "N/A"}\`\n` +
                    `- *Test:* \`${testName}\`\n` +
                    `- *Time:* \`${timestamp}\``;
            } else if (eventData.type === "Test Submitted") {
                messageText = `‚úÖ *Test Submitted!*\n\n` +
                    `- *User:* \`${eventData.userName || "N/A"}\`\n` +
                    `- *Mobile:* \`${eventData.userMobile || "N/A"}\`\n` +
                    `- *Test:* \`${testName}\`\n` +
                    `- *Score:* *${eventData.score}*\n` +
                    `- *Correct:* ${eventData.correct}\n` +
                    `- *Incorrect:* ${eventData.incorrect}\n` +
                    `- *Unattempted:* ${eventData.unattempted}\n` +
                    `- *Time:* \`${timestamp}\``;
            }
            
            try {
                // ===== TELEGRAM GROUP TOPIC ME MESSAGE BHEJNA =====
                // message_thread_id parameter group topic specify karta hai
                await fetch(apiURL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        chat_id: CHAT_ID,
                        text: messageText,
                        parse_mode: "Markdown",
                        message_thread_id: TOPIC_ID  // ‚≠ê YE LINE GROUP TOPIC ME BHEJNE KE LIYE
                    })
                });
            } catch (error) {
                console.error("Telegram log failed:", error);
            }
        }

        /**
         * PDF Report generate aur download karta hai
         * Hindi aur English dono languages support karta hai
         * Android app me bhi kaam karta hai
         * 
         * @param {HTMLElement} buttonElement - PDF download button
         */
        async function downloadPDF(buttonElement) {
            const btn = buttonElement;
            const originalHTML = btn.innerHTML;
            btn.disabled = true;

            // Loading overlay show karo
            const overlay = document.createElement('div');
            overlay.className = 'pdf-generating-overlay';
            overlay.innerHTML = `<div class="spinner-border" role="status"></div>
                <p>Generating PDF...</p>
                <p id="pdf-progress-text" style="font-size: 0.9em;"></p>`;
            document.body.appendChild(overlay);
            const progressText = document.getElementById('pdf-progress-text');

            try {
                const { jsPDF: jsPDF_lib } = window.jspdf;
                const doc = new jsPDF_lib({
                    unit: "pt",
                    format: "a4",
                    orientation: "portrait"
                });
                const fileName = `${testTitle} Result by Kundan.pdf`;
                
                // Check karo ki Android app me hai ya nahi
                const isAndroidApp = window.Android && typeof window.Android.startPdf === 'function';

                /**
                 * Android app me PDF save karne ka helper function
                 * Badi files ke liye streaming use karta hai
                 */
                const saveInApp = (pdfDoc) => {
                    progressText.textContent = "Saving to device...";
                    
                    setTimeout(() => {
                        const pdfDataString = pdfDoc.output('datauristring');
                        
                        // Choti files direct save karo
                        if (currentLang !== 'hi' && pdfDataString.length < 2000000) { // 2MB se choti
                            window.Android.saveBase64String(pdfDataString, fileName);
                            return;
                        }

                        // Badi files streaming se save karo (memory efficient)
                        const pureBase64 = pdfDataString.split(',')[1];
                        const downloadId = `pdf_${Date.now()}`;
                        
                        window.Android.startPdf(downloadId, fileName);
                        
                        const chunkSize = 16384; // 16KB chunks
                        for (let i = 0; i < pureBase64.length; i += chunkSize) {
                            const chunk = pureBase64.substring(i, i + chunkSize);
                            window.Android.appendPdfChunk(downloadId, chunk);
                        }
                        
                        window.Android.finishPdf(downloadId);
                    }, 50);
                };

                // ===== HINDI PDF GENERATION (html2canvas method) =====
                if (currentLang === 'hi') {
                    progressText.textContent = "Initializing Hindi PDF...";
                    
                    const pdfWidth = doc.internal.pageSize.getWidth();
                    const margin = 40;
                    let yPosition = margin;
                    
                    // ----- Header Section (Stats + Chart) -----
                    const headerContainer = document.createElement('div');
                    headerContainer.style.width = '700px';
                    headerContainer.style.padding = '20px';
                    headerContainer.style.background = '#fff';
                    headerContainer.style.color = '#000';
                    
                    let headerHTML = `<div style="text-align:center;">
                        <h1>Test Analysis: ${testTitle}</h1>
                        <p><strong>Developer: Kundan Yadav</strong></p>
                        <hr>
                        <p><strong>User:</strong> ${userName || "N/A"} | <strong>Mobile:</strong> ${userMobile || "N/A"}</p>
                    </div>
                    <hr>
                    <div style="display:flex; justify-content:space-around; text-align:center; margin:20px 0;">
                        <div><h3>${document.getElementById("score-value").textContent}</h3><p>Score</p></div>
                        <div><h3>${document.getElementById("correct-value").textContent}</h3><p>Correct</p></div>
                        <div><h3>${document.getElementById("incorrect-value").textContent}</h3><p>Incorrect</p></div>
                        <div><h3>${document.getElementById("unattempted-value").textContent}</h3><p>Unattempted</p></div>
                    </div>
                    <div style="text-align:center; margin:20px 0;">
                        <img src="${document.getElementById("topicAnalysisChart").toDataURL("image/png", 1.0)}" 
                             style="width:100%; max-width:500px;" />
                    </div>`;
                    
                    headerContainer.innerHTML = headerHTML;
                    document.body.appendChild(headerContainer);
                    
                    // Header ko canvas me convert karke PDF me add karo
                    const headerCanvas = await html2canvas(headerContainer, { scale: 1.5 });
                    const headerImgData = headerCanvas.toDataURL('image/png');
                    const headerImgHeight = (headerCanvas.height * (pdfWidth - 2 * margin)) / headerCanvas.width;
                    doc.addImage(headerImgData, 'PNG', margin, yPosition, pdfWidth - 2 * margin, headerImgHeight);
                    yPosition += headerImgHeight + 20;
                    document.body.removeChild(headerContainer);

                    // WebView ko breathe karne ka time do (crash prevention)
                    await new Promise(resolve => setTimeout(resolve, 10));
                    
                    // ----- Questions Loop -----
                    for (let i = 0; i < questions.length; i++) {
                        progressText.textContent = `Processing question ${i + 1} of ${questions.length}...`;
                        
                        const q = questions[i];
                        const questionContainer = document.createElement('div');
                        questionContainer.style.width = '700px';
                        questionContainer.style.padding = '20px';
                        questionContainer.style.background = '#fff';
                        questionContainer.style.color = '#000';
                        
                        const questionText = q.question_hi || q.question_en;
                        const solutionText = q.solution_hi || q.solution_en;
                        const optionsArray = q.options_hi || q.options_en;
                        
                        // Options HTML with correct/incorrect marking
                        let optionsHTML = '';
                        const userAnswer = answers[q.id];
                        const correctAnswer = q.correct;
                        const optionKeys = ['a', 'b', 'c', 'd'];
                        
                        optionsArray.forEach((opt, idx) => {
                            const optionKey = optionKeys[idx];
                            let style = 'margin:5px 0; font-family: sans-serif;';
                            let prefix = `${String.fromCharCode(65 + idx)}) `;
                            
                            if (optionKey === correctAnswer) {
                                style += ' color: green; font-weight: bold;';
                                if (userAnswer === optionKey) {
                                    prefix = `‚úì ${prefix}`;
                                }
                            } else if (optionKey === userAnswer) {
                                style += ' color: red;';
                                prefix = `‚úó ${prefix}`;
                            }
                            
                            optionsHTML += `<p style="${style}">${prefix}${opt}</p>`;
                        });
                        
                        const status = answers[q.id] ? 
                            (answers[q.id] === q.correct ? "Correct" : "Incorrect") : 
                            "Unattempted";
                        const time = timeSpent[q.id] || 0;
                        const minutes = Math.floor(time / 60);
                        const seconds = time % 60;
                        const timeTakenText = `${minutes}m ${seconds}s`;
                        
                        questionContainer.innerHTML = `<hr>
                            <div style="font-family: sans-serif; overflow: hidden;">
                                <h4>Q${i + 1}: ${questionText}</h4>
                                ${optionsHTML}
                                <p><strong>Status:</strong> ${status} 
                                   <span style="float: right; color: #555; font-size: 0.9em;">Time Taken: ${timeTakenText}</span>
                                </p>
                                <div style="background:#f0f8ff; padding:10px; border-radius:5px; margin-top: 10px;">
                                    <strong>Solution:</strong> ${solutionText}
                                </div>
                            </div>`;
                        
                        document.body.appendChild(questionContainer);
                        
                        // Canvas me convert karo
                        const qCanvas = await html2canvas(questionContainer, { scale: 1.5 });
                        const qImgData = qCanvas.toDataURL('image/png');
                        const qImgHeight = (qCanvas.height * (pdfWidth - 2 * margin)) / qCanvas.width;
                        
                        // New page add karo agar space nahi hai
                        if (yPosition + qImgHeight > doc.internal.pageSize.getHeight() - margin) {
                            doc.addPage();
                            yPosition = margin;
                        }
                        
                        doc.addImage(qImgData, 'PNG', margin, yPosition, pdfWidth - 2 * margin, qImgHeight);
                        yPosition += qImgHeight;
                        document.body.removeChild(questionContainer);
                        
                        // UI Thread ko breathe karne ka time
                        await new Promise(resolve => setTimeout(resolve, 10));
                    }
                    
                    // PDF save karo
                    if (isAndroidApp) {
                        saveInApp(doc);
                    } else {
                        doc.save(fileName);
                    }
                    
                } else {
                    // ===== ENGLISH PDF GENERATION (jsPDF text method) =====
                    progressText.textContent = "Processing English PDF...";
                    
                    let yPos = 40;
                    const marginX = 40;
                    const pageWidth = doc.internal.pageSize.width - 2 * marginX;
                    
                    // Helper function for new page
                    const addNewPage = () => {
                        doc.addPage();
                        yPos = marginX;
                    };
                    
                    // ----- Title -----
                    doc.setFont("Helvetica", "bold");
                    doc.setFontSize(18);
                    doc.text(`Test Analysis: ${testTitle}`, doc.internal.pageSize.width / 2, yPos, { align: "center" });
                    
                    // ----- Developer Link -----
                    yPos += 25;
                    doc.setFont("Helvetica", "bold");
                    doc.setFontSize(12);
                    doc.setTextColor(0, 84, 166);
                    const devText = "Developer: Kundan Yadav";
                    doc.textWithLink(devText, doc.internal.pageSize.width / 2, yPos, {
                        url: "https://t.me/kundan_yadav_bot",
                        align: "center"
                    });
                    
                    // ----- User Details -----
                    doc.setFont("Helvetica", "normal");
                    doc.setTextColor(0, 0, 0);
                    yPos += 25;
                    doc.setFontSize(12);
                    doc.text(`User: ${userName || "N/A"}`, marginX, yPos);
                    yPos += 15;
                    doc.text(`Mobile: ${userMobile || "N/A"}`, marginX, yPos);
                    
                    // ----- Divider Line -----
                    yPos += 20;
                    doc.setLineWidth(1.5);
                    doc.line(marginX, yPos, doc.internal.pageSize.width - marginX, yPos);
                    
                    // ----- Stats Cards -----
                    yPos += 30;
                    doc.setFontSize(10);
                    const cardWidth = (pageWidth - 30) / 4;
                    const cardHeight = 50;
                    
                    const statsData = [
                        { label: "Score", value: document.getElementById("score-value").textContent, color: [0, 123, 255] },
                        { label: "Correct", value: document.getElementById("correct-value").textContent, color: [40, 167, 69] },
                        { label: "Incorrect", value: document.getElementById("incorrect-value").textContent, color: [220, 53, 69] },
                        { label: "Unattempted", value: document.getElementById("unattempted-value").textContent, color: [108, 117, 125] }
                    ];
                    
                    statsData.forEach((item, index) => {
                        doc.setFillColor(item.color[0], item.color[1], item.color[2]);
                        doc.roundedRect(marginX + index * (cardWidth + 10), yPos, cardWidth, cardHeight, 5, 5, "F");
                        
                        doc.setTextColor(255, 255, 255);
                        doc.setFont("Helvetica", "bold");
                        doc.setFontSize(16);
                        doc.text(item.value, marginX + index * (cardWidth + 10) + cardWidth / 2, yPos + 25, { align: "center" });
                        
                        doc.setFont("Helvetica", "normal");
                        doc.setFontSize(10);
                        doc.text(item.label, marginX + index * (cardWidth + 10) + cardWidth / 2, yPos + 40, { align: "center" });
                    });
                    
                    // ----- Topic Analysis Chart -----
                    yPos += cardHeight + 30;
                    const chartCanvas = document.getElementById("topicAnalysisChart");
                    const chartImage = chartCanvas.toDataURL("image/png", 1.0);
                    doc.addImage(chartImage, "PNG", marginX, yPos, pageWidth, pageWidth / 2);
                    yPos += pageWidth / 2 + 30;
                    
                    doc.setTextColor(0, 0, 0);
                    
                    // ----- Questions Loop -----
                    questions.forEach((q, qIndex) => {
                        // Check page space
                        if (yPos > doc.internal.pageSize.height - 150) addNewPage();
                        
                        // Divider
                        doc.setLineWidth(0.5);
                        doc.line(marginX, yPos, doc.internal.pageSize.width - marginX, yPos);
                        yPos += 20;
                        
                        // Question text
                        const questionText = q.question_en || "";
                        doc.setFont("Helvetica", "bold");
                        doc.setFontSize(11);
                        const wrappedQuestion = doc.splitTextToSize(`Q${qIndex + 1}: ${questionText.replace(/\n/g, " ")}`, pageWidth);
                        doc.text(wrappedQuestion, marginX, yPos);
                        yPos += 12 * wrappedQuestion.length + 10;
                        
                        // Options
                        doc.setFont("Helvetica", "normal");
                        doc.setFontSize(10);
                        const optionKeys = ["a", "b", "c", "d"];
                        const optionsArray = q.options_en || [];
                        
                        optionsArray.forEach((optText, optIndex) => {
                            const userAnswer = answers[q.id];
                            const correctAnswer = q.correct;
                            const currentOptionKey = optionKeys[optIndex];
                            
                            let optionText = `${String.fromCharCode(65 + optIndex)}) ${optText}`;
                            
                            if (currentOptionKey === correctAnswer) {
                                doc.setTextColor(40, 167, 69); // Green
                                optionText = (userAnswer === currentOptionKey ? "‚úì " : "  ") + optionText;
                            } else if (currentOptionKey === userAnswer) {
                                doc.setTextColor(220, 53, 69); // Red
                                optionText = `‚úó ${optionText}`;
                            } else {
                                doc.setTextColor(50, 50, 50);
                                optionText = `  ${optionText}`;
                            }
                            
                            doc.text(optionText, marginX + 15, yPos);
                            yPos += 15;
                        });
                        
                        doc.setTextColor(0, 0, 0);
                        
                        // Status and time
                        const timeValue = timeSpent[q.id] || 0;
                        const mins = Math.floor(timeValue / 60);
                        const secs = timeValue % 60;
                        
                        let statusText = answers[q.id] ?
                            (answers[q.id] === q.correct ? "Correct" : "Incorrect") :
                            "Unattempted";
                        
                        let statusColor = answers[q.id] ?
                            (answers[q.id] === q.correct ? [40, 167, 69] : [220, 53, 69]) :
                            [108, 117, 125];
                        
                        doc.setFont("Helvetica", "bold");
                        doc.setTextColor(statusColor[0], statusColor[1], statusColor[2]);
                        doc.text(`Status: ${statusText}`, marginX, yPos);
                        
                        doc.setFont("Helvetica", "normal");
                        doc.setFontSize(9);
                        doc.setTextColor(108, 117, 125);
                        doc.text(`Time Taken: ${mins}m ${secs}s`, doc.internal.pageSize.width - marginX, yPos, { align: "right" });
                        
                        yPos += 20;
                        
                        // Solution box
                        doc.setFillColor(240, 248, 255);
                        const solutionText = q.solution_en || "";
                        const wrappedSolution = doc.splitTextToSize(`Solution: ${solutionText}`, pageWidth - 20);
                        doc.roundedRect(marginX, yPos - 10, pageWidth, 12 * wrappedSolution.length + 15, 3, 3, "F");
                        
                        doc.setTextColor(50, 50, 50);
                        doc.text(wrappedSolution, marginX + 10, yPos);
                        yPos += 12 * wrappedSolution.length + 15;
                    });
                    
                    // Save PDF
                    if (isAndroidApp) {
                        saveInApp(doc);
                    } else {
                        doc.save(fileName);
                    }
                }
                
            } catch (error) {
                console.error("Error generating PDF:", error);
                alert("Sorry, there was an error generating the PDF.");
            } finally {
                // Cleanup
                btn.disabled = false;
                btn.innerHTML = originalHTML;
                if (overlay) {
                    document.body.removeChild(overlay);
                }
            }
        }
    </script>
</body>
</html>